<!-- ajax layout which only needs content area -->
<div class="row">
    <div class="col-xs-12 form-btn-wrapper">
    <!-- 界面开始 -->
    <div class="form-horizontal" role="form">


    <!-- 固件版本 -->
    <div class="form-group">
        <label class="col-sm-3 control-label no-padding-right" data-i18n="Version"></label>
        <div class="col-sm-9">
          <div id="current_version" class="col-xs-10 col-sm-5 form-right-text"></div>
        </div>
    </div>
    <!-- 设备SN -->
    <div class="form-group">
        <label class="col-sm-3 control-label no-padding-right" data-i18n="Device Serial Number"></label>
        <div class="col-sm-9">
          <div id="current_sn" class="col-xs-10 col-sm-5 form-right-text"></div>
        </div>
    </div>
    <!-- Mode -->
    <div class="form-group">
        <label class="col-sm-3 control-label no-padding-right" data-i18n="Current Mode"></label>
        <div class="col-sm-9">
          <div id="current_mode" class="col-xs-10 col-sm-5 form-right-text"></div>
        </div>
    </div>
    <!-- 激活状态 -->
    <div class="form-group">
        <label class="col-sm-3 control-label no-padding-right" data-i18n="Active State"></label>
        <div class="col-sm-9">
          <div id="current_state" class="col-xs-10 col-sm-5 form-right-text"></div>
        </div>
    </div>


    <!-- 开始激活 -->
    <div id="active-set"  style="display: none;">
        <div class="hr hr32 hr-dotted"></div>
        <div class="form-group">
            <label class="col-sm-3 control-label no-padding-right" data-i18n="Active Device"></label>
            <div class="col-sm-9">
              <button class="btn btn-yellow" id="active" data-i18n="Active"></button>
            </div>
        </div>

        <div id="active-status" style="display: none;">
            <div class="form-group">
                <label class="col-sm-3 control-label no-padding-right" data-i18n="Activation Identify"></label>
                <div class="col-sm-9">
                  <div id="Activation_ActivationId" class="col-xs-10 col-sm-5 form-right-text"></div>
                </div>
            </div>
            <div class="form-group">
                <label class="col-sm-3 control-label no-padding-right" data-i18n="Activation Link"></label>
                <div class="col-sm-9">
                    <a class="btn btn-second" data-i18n="Activation Button" id="Activation_url" href="#"></a>
                </div>
            </div>
            <div class="form-group">
                <label class="col-sm-3 control-label no-padding-right" data-i18n="Activation Progress"></label>
                <div class="col-sm-9">
                    <div id="Activation_progress" class="col-xs-10 col-sm-5 form-right-text"></div>
                </div>
            </div>
        </div>
    </div>





    <div class="hr hr32 hr-dotted"></div>

    <!-- 开启云加速 -->
    <div class="form-group">
        <label class="col-sm-3 control-label no-padding-right" data-i18n="Enable Accelerate"></label>
        <div class="col-sm-9">
          <select class="col-xs-10 col-sm-5" id="mode">
            <option value="low_latency" data-i18n="low_latency"></option>
            <option value="high_throughput" data-i18n="high_throughput"></option>
            <option value="dynamic_adjustment" data-i18n="dynamic_adjustment"></option>
          </select>
        </div>
        
    </div>
    <div class="form-group">
        <label class="col-sm-3 control-label no-padding-right"></label>
        <div class="col-sm-9">
            <button class="btn btn-main" id="accelerate" data-i18n="Accelerate"></button>
        </div>
    </div>

    <!-- 关闭云加速 -->
    <div class="form-group">
        <label class="col-sm-3 control-label no-padding-right" data-i18n="Disable Accelerate"></label>
        <div class="col-sm-9">
          <button class="btn btn-second" id="stop" data-i18n="Disable"></button>
        </div>
    </div>

    <!-- 强制介入 -->
    <div id="accel-failed"  style="display: none;">
        <div class="form-group">
            <label class="col-sm-3 control-label no-padding-right" data-i18n="Force Disable Accelerate"></label>
            <div class="col-sm-9">
              <span id="accel_msg"></span>
              <button class="btn btn-danger" id="force" data-i18n="Disable"></button>
            </div>
        </div>
    </div>


    </div>
    <!-- 界面结束 -->
  </div><!-- /.col -->
</div><!-- /.row -->



<!-- page specific plugin scripts -->
<script type="text/javascript">
(function () {
    // Javascript开始

    // 组件配置名称
    var comname = "xglink@mpt";
    // 语言文件路径, 自动跟据系统语言类型变化路径(在prj.json中指名)
    var langjson = base64.decode( page.param( 'lang', location.hash ) );



    /* load the active */
    var active_id = null;
    var active_timer = null;
    function load_active()
    {
      he.bkload( [ comname+"getDeviceActivationStatus[ "+active_id+"]" ] ).then( function(v){
        var a;
        if ( v[0] )
        {
            a = v[0].Activation;
            if ( a )
            {
                $("#Activation_progress").text( a.Status );
            }
        }
      })
    }
    /* load the status */
    function load_status()
    {
      he.bkload( [ comname+".status", comname+".getActivation" ] ).then( function(v){

        if ( v[0] )
        {
            $("#current_version").text( v[0].Version );
            $("#current_sn").text( v[0].SN );
            $("#current_mode").text( $.i18n(v[0].Mode) );
        }
        if ( v[1] )
        {
            if ( v[1].rc == "403" )
            {
                $("#current_state").text( $.i18n("Network Failed") );
                $("#active-set").hide();
            }
            else if ( v[1].rc == "401" )
            {
                $("#current_state").text( $.i18n("Exception") );
                $("#active-set").hide();
            }
            else if ( v[1].rc == "411" )
            {
                $("#current_state").text( $.i18n("Server Failed") );
                $("#active-set").hide();
            }
            else if ( v[1].rc == "0" )
            {
                if ( v[1].stdout == "activated" )
                {
                    $("#current_state").text( $.i18n(v[1].stdout) );
                    $("#active-set").hide();
                }
                else
                {
                    $("#current_state").text( $.i18n("No Activated") );
                    $("#active-set").show();
                    // 清除定时器
                    if ( active_timer )
                    {
                        clearInterval( active_timer );
                        active_timer = null;
                    }
                }
            }
        }
      })
    }

    // 加载语言文件
    $.i18n().load( page.lang(langjson) ).then( function () {
        // 界面语言初始化
        $.i18n().locale = window.lang; $('body').i18n();

        // 设置定时器
        page.timing({
          refresh: function ()
          {
              load_status();
          },
          interval: 1000
        });


        /* 绑定激活 */
        $('#active').on(ace.click_event, function () {
            he.exec( [ comname+".startDeviceActivation" ] ).then( function(v){
                var ret = v[0];
                if ( ret && ret.ActivationId )
                {
                    active_id = ret.ActivationId;
                    $("#ActivationId").text( ret.ActivationId );
                    $('#Activation_url').attr( "href", ret.Url );
                    $("#active-status").show();
                    page.hint2succeed($.i18n('Start to activate...'));
                    // 清除原定时器
                    if ( active_timer )
                    {
                        clearInterval( active_timer );
                        active_timer = null;
                    }
                    // 设置定时器
                    active_timer = page.timing({
                      refresh: function ()
                      {
                          load_active();
                      },
                      interval: 1000
                    });
                }
                else
                {
                    $("#active-status").hide();
                    page.hint2warning( $.i18n('Activation failed') );
                    // 清除定时器
                    if ( active_timer )
                    {
                        clearInterval( active_timer );
                        active_timer = null;
                    }
                }
            });
        
        });


        /* 绑定加速键 */
        $('#accelerate').on(ace.click_event, function () {
            var mode = $("#mode").val();
            he.exec( [ comname+".startSession["+mode+"]" ] ).then( function(v){
                var ret = v[0];
                if ( ret && ret.result == "云加速开启成功" )
                {
                    $("#accel-failed").hide();
                    page.hint2succeed( ret.result );
                }
                else
                {
                    var log = "";
                    for ( var i in v[0] )
                    {
                        log += i;
                        log += ":";
                        log += v.changelog[i];
                        log += "<br>";
                    }
                    $('#accel_msg').html( log );
                    $("#accel-failed").show();
                    page.hint2warning( ret.result );
                }
            });
        
        });

        /* 绑定关闭键 */
        $('#stop').on(ace.click_event, function () {
            he.exec( [ comname+".stopSession" ] ).then( function(v){
                var ret = v[0];
                if ( ret && ret.result == "云加速关闭成功" )
                {
                    var log = "";
                    for ( var i in v[0] )
                    {
                        log += i;
                        log += ":";
                        log += v.changelog[i];
                        log += "<br>";
                    }
                    $('#accel_msg').html( log );
                    $("#accel-failed").hide();
                    page.hint2succeed( ret.result );
                }
                else
                {
                    $("#accel-failed").show();
                    page.hint2warning( ret.result );
                }
            });
        
        });

        /* 绑定强制关闭键 */
        $('#force').on(ace.click_event, function () {
            he.exec( [ comname+".force" ] ).then( function(v){
                var ret = v[0];
                if ( ret == true )
                {
                    $("#accel-failed").hide();
                    page.hint2succeed( $.i18n("Force disable succeed") );
                }
                else
                {
                    page.hint2warning( $.i18n("Force disable failed") );
                }
            });
        
        });




        
    });



    // Javascript结束
})()
</script>
