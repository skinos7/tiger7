<!-- ajax layout which only needs content area -->
<div class="row" id="page-modes">
  <div class="col-xs-12 form-btn-wrapper">
    <!-- PAGE CONTENT BEGINS -->
    <div class="form-horizontal" role="form">


        <!-- 连接状态 -->
        <table class="table table-bordered table-striped">
        <tbody>
            <tr>
                <th data-i18n="Status"></th><td id="lte_status"></td>
                <th data-i18n="VID/PID"></th><td id="lte_vidpid"></td>
            </tr>
            <tr>
                <th data-i18n="Operator"></th><td id="lte_operator"></td>
                <th data-i18n="Network"></th><td id="lte_nettype"></td>
            </tr>
            <tr>
                <th data-i18n="RSSI"></th>
                <td>
                    <span><img src="/assets/css/images/signal_0.png" id="lte_rssiimg" class="line-signal"></img></span>
                    <span id="lte_rssi"></span>
                </td>
                <th data-i18n="IMEI"></th><td id="lte_imei"></td>
            </tr>
            <tr>
                <th data-i18n="IMSI"></th><td id="lte_imsi"></td>
                <th data-i18n="ICCID"></th><td id="lte_iccid"></td>
            </tr>
        </tbody>
        </table>            



        <div class="hr hr32 hr-dotted"></div>

        <!-- 网络模式 -->
        <div class="form-group">
          <label class="col-sm-3 control-label no-padding-right" for="netmode" data-i18n="Attach Mode"></label>
          <div class="col-sm-9">
            <select class="col-xs-10 col-sm-5" id="netmode">
              <option value="auto" data-i18n="Auto"></option>
              <option value="nsa" data-i18n="5G NSA"></option>
              <option value="sa" data-i18n="5G SA"></option>
              <option value="4g" data-i18n="4G"></option>
              <option value="3g" data-i18n="3G"></option>
              <option value="2g" data-i18n="2G"></option>
            </select>
          </div>
        </div>

        <!-- 保持指定的模式 -->
        <div class="form-group">
          <label class="col-sm-3 control-label no-padding-right" for="watchnet_mode" data-i18n="Maintain Network Mode"></label>
          <div class="col-sm-9">
            <select class="col-xs-10 col-sm-5" id="watchnet_mode">
              <option value="disable" data-i18n="Disable"></option>
              <option value="4g" data-i18n="4G"></option>
              <option value="3g4g" data-i18n="3G4G"></option>
            </select>
          </div>
        </div>
        <div id="watchnetSets" style="display: none;">
          <div class="form-group">
            <label class="col-sm-3 control-label no-padding-right" for="watchnet2reset" data-i18n="Detect Network Mode Times"></label>
            <div class="col-sm-9">
              <input type="text" id="watchnet2reset" class="col-xs-10 col-sm-5" maxlength="128" />
            </div>
          </div>
          <div class="form-group">
            <label class="col-sm-3 control-label no-padding-right"></label>
            <div class="col-sm-9">
              <span data-i18n="Network mode is detected every 10 seconds. If the baseband is not in the specified network mode and reaches the specified number of times, the baseband will be restarted" ></span>
            </div>
          </div>
        </div> <!-- watchnetSets -->

        <div class="hr hr32 hr-dotted"></div>


        <!-- APN自定义 -->
        <div class="form-group">
          <label class="col-sm-3 control-label no-padding-right" for="operator" data-i18n="APN Custom"></label>
          <div class="col-sm-9">
            <label>
              <input id="operator" class="ace ace-switch ace-switch-6" type="checkbox" />
              <span class="lbl"></span>
            </label>
          </div>
        </div>
        <!-- APN列表 -->
        <div class="form-group" id="apnList" style="display: none;">
          <label class="col-sm-3 control-label no-padding-right" data-i18n="APN List"></label>
          <div class="col-sm-9">
            <div class="col-sm-9 form-right-text">
              <span class="link second-color" id="apn_list" data-i18n="Edit"></span>
            </div>
          </div>
        </div>
        <div id="apnSets" style="display: none;">
          <!-- 拨号号码 -->
          <div class="form-group">
            <label class="col-sm-3 control-label no-padding-right" for="dial" data-i18n="Dial Number"></label>
            <div class="col-sm-9">
              <input type="text" id="dial" class="col-xs-10 col-sm-5" maxlength="128" />
            </div>
          </div>
          <!-- APN -->
          <div class="form-group">
            <label class="col-sm-3 control-label no-padding-right" for="apn" data-i18n="APN"></label>
            <div class="col-sm-9">
              <input type="text" id="apn" class="col-xs-10 col-sm-5" maxlength="128" />
            </div>
          </div>
          <!-- 用户名 -->
          <div class="form-group">
            <label class="col-sm-3 control-label no-padding-right" for="user" data-i18n="Username"></label>
            <div class="col-sm-9">
              <input type="text" id="user" class="col-xs-10 col-sm-5" maxlength="128" />
            </div>
          </div>
          <!-- 密码 -->
          <div class="form-group">
            <label class="col-sm-3 control-label no-padding-right" for="password" data-i18n="Password"></label>
            <div class="col-sm-9">
              <span class="input-icon input-icon-right input-icon-form col-xs-10 col-sm-5">
                <input type="password" id="password" maxlength="128" autocomplete="new-password" />
                <i class="ace-icon fa fa-eye-slash" id="password-icon"></i>
              </span>
            </div>
          </div>
          <!-- IP方式 -->
          <div class="form-group">
            <label class="col-sm-3 control-label no-padding-right" for="type" data-i18n="IP Type"></label>
            <div class="col-sm-9">
              <select class="col-xs-10 col-sm-5" id="type">
                <option value="" data-i18n="IP"></option>
                <option value="ipv4v6" data-i18n="IPV4V6"></option>
                <option value="ipv6" data-i18n="IPV6"></option>
              </select>
            </div>
          </div>
          <!-- 鉴权方式 -->
          <div class="form-group">
            <label class="col-sm-3 control-label no-padding-right" for="auth" data-i18n="Authentication"></label>
            <div class="col-sm-9">
              <select class="col-xs-10 col-sm-5" id="auth">
                <option value="" data-i18n="Auto"></option>
                <option value="disable" data-i18n="None"></option>
                <option value="pap" data-i18n="PAP"></option>
                <option value="chap" data-i18n="CHAP"></option>
                <option value="papchap" data-i18n="PAP&CHAP"></option>
              </select>
            </div>
          </div>
          <!-- 拨号CID -->
          <div class="form-group">
            <label class="col-sm-3 control-label no-padding-right" for="cid" data-i18n="Dial CID"></label>
            <div class="col-sm-9">
              <input type="text" id="cid" class="col-xs-10 col-sm-5" maxlength="128" />
            </div>
          </div>
        </div>


     <div class="hr hr32 hr-dotted"></div>
     <!-- GPS -->
     <div class="form-group">
       <label class="col-sm-3 control-label no-padding-right" for="gnss" data-i18n="GPS"></label>
       <div class="col-sm-9">
         <label>
           <input id="gnss" class="ace ace-switch ace-switch-6" type="checkbox" />
           <span class="lbl"></span>
         </label>
       </div>
     </div>
     <!-- Band -->
     <div class="form-group">
       <label class="col-sm-3 control-label no-padding-right" for="band" data-i18n="Band"></label>
       <div class="col-sm-9">
         <input type="text" id="band" class="col-xs-10 col-sm-5" maxlength="128" />
       </div>
     </div>
    
    <!-- PIN码 -->
    <div class="form-group">
      <label class="col-sm-3 control-label no-padding-right" for="pin" data-i18n="PIN Code"></label>
      <div class="col-sm-9">
        <input type="text" id="pin" class="col-xs-10 col-sm-5" maxlength="128" />
      </div>
    </div>
      

      <div class="clearfix form-actions">
        <div class="col-md-offset-3 col-md-9">
          <button class="btn btn-second" type="button" id="refresh"><span data-i18n="Refresh"></span></button>
          &nbsp; &nbsp; &nbsp;
          <button class="btn btn-main" type="button" id="apply"><span data-i18n="Apply"></span></button>
        </div>
      </div>


    </div>
    <!-- PAGE CONTENT ENDS -->
  </div><!-- /.col -->
</div><!-- /.row -->



<!-- page specific plugin scripts -->
<script type="text/javascript">
  (function () {
    /* get the object */
    var lte;
    var ltes;
    var obj = "modem@lte";
    var index = location.hash.indexOf("obj=");
    if ( index > 0 )
    {
      obj = location.hash.substring( index+4 );
    }
    /* load the configure on the input */
    function lte_load()
    {
      he.load( [ obj ] ).then( function(v){
        lte = v[0];
        $('#netmode').val(lte.netmode || 'auto');
        $('#watchnet_mode').val(lte.watchnet_mode || 'disable');
        $('#watchnet2reset').val(lte.watchnet2reset|| '' );
        if ( lte.operator == "enable" )
        {
            $('#operator').prop('checked', true );
        }
        else
        {
            $('#operator').prop('checked', false );
        }
        if ( lte.operator_cfg )
        {
          $('#dial').val(lte.operator_cfg.dial);
          $('#apn').val(lte.operator_cfg.apn);
          $('#user').val(lte.operator_cfg.user);
          $('#password').val(lte.operator_cfg.passwd);
          $('#type').val(lte.operator_cfg.type);
          $('#auth').val(lte.operator_cfg.auth);
          $('#cid').val(lte.operator_cfg.cid);
        }
        else
        {
            if ( ltes && ltes.operator_advise )
            {
                $('#dial').val(ltes.operator_advise.dial);
                $('#apn').val(ltes.operator_advise.apn);
                $('#user').val(ltes.operator_advise.user);
                $('#password').val(ltes.operator_advise.passwd);
                $('#type').val(ltes.operator_advise.type);
                $('#auth').val(ltes.operator_advise.auth);
                $('#cid').val(ltes.operator_advise.cid);
            }
        }
        $('#pin').val(lte.pin);
        $('#gnss').prop('checked',  false );
        if ( lte.gnss && lte.gnss.status == "enable" )
        {
            $('#gnss').prop('checked',  true );
        }
        $('#band').val(lte.band);
        $('#watchnet_mode').unbind('change').change(function (e) {
          var type = e.target.value;
          if ( type == "4g" || type == "3g4g" )
          {
            $('#watchnetSets').show();
          }
          else
          {
            $('#watchnetSets').hide();
          }
        }).trigger('change');
        $('#operator').unbind('change').change(function () {
          if ($(this).prop('checked'))
          {
            $('#apnSets').show();
            $('#apnList').hide();
          } 
          else
          {
            $('#apnSets').hide();
            $('#apnList').hide();
          }
        }).trigger('change');
      })
    }


    /* load the status */
    function status_load()
    {
      he.bkload( [ obj+".status" ] ).then( function(v){
          ltes = v[0];
          var info = ltes;
          var id = "#lte";
          /* status end btn */
          if ( info.error )
          {
              $(id+"_status").text( $.i18n(info.error) );
          }
          else if ( info.step )
          {
              $(id+"_status").text( $.i18n(info.step) );
          }
          /* modom */
          $(id+"_operator").text( info.operator||' ' );
          $(id+"_nettype").text( info.nettype||' ' );
          if ( info.rssi )
          {
              $(id+"_rssi").text( info.rssi+"dBm" );
          }
          if ( info.signal )
          {
              $(id+"_rssiimg").attr( "src", "/assets/css/images/signal_"+info.signal+".png" );            
          }
          else
          {
              $(id+"_rssiimg").attr( "src", "/assets/css/images/signal_0.png" );            
          }
          if ( info.nettype5 && info.signal5 )
          {
              $(id+"_nettype").text( info.nettype5||' ' );
              if ( info.rsrp5 )
              {
                  $(id+"_rssi").text( info.rsrp5+"dBm" );
              }
              if ( info.signal5 )
              {
                  $(id+"_rssiimg").attr( "src", "/assets/css/images/signal_"+info.signal5+".png" );            
              }
          }
          if ( info.pid )
          {
              $(id+"_vidpid").text( (info.vid||' ') +"/"+ (info.pid||' ') );
          }
          else
          {
              $(id+"_vidpid").text( ' ' );        
          }
          $(id+"_imei").text( info.imei||' ' );
          $(id+"_imsi").text( info.imsi||' ' );
          $(id+"_iccid").text( info.iccid||' ' );
      })
    }


    /* save the configure */
    function lte_save()
    {
      if ( lte == null )
      {
        return;
      }
      var ltecopy = JSON.parse(JSON.stringify(lte));;

      lte.netmode = $('#netmode').val();
      lte.watchnet_mode = $('#watchnet_mode').val();
      lte.watchnet2reset = $('#watchnet2reset').val();
      lte.pin = $('#pin').val();
      lte.band = $('#band').val();
      lte.operator = boole2able( $('#operator').prop('checked') );
      if ( lte.operator == "enable" )
      {
        if ( !lte.operator_cfg )
        {
          lte.operator_cfg = {};
        }
        lte.operator_cfg.dial = $('#dial').val();
        lte.operator_cfg.apn = $('#apn').val();
        if ( !lte.operator_cfg.apn )
        {
            page.alert( { message: $.i18n('APN')+" "+$.i18n('can not be empty') } );
            return;
        }
        lte.operator_cfg.user = $('#user').val();
        lte.operator_cfg.passwd = $('#password').val();
        lte.operator_cfg.type = $('#type').val();
        lte.operator_cfg.auth = $('#auth').val();
        lte.operator_cfg.cid = $('#cid').val();
        if ( lte.operator_cfg.cid && check.number(lte.operator_cfg.cid) == false )
        {
            page.alert( { message: $.i18n('Dial CID')+" "+$.i18n('must be a valid number') } );
            return;
        }
      }
      if ( $('#gnss').prop('checked') == true )
      {
        if ( !lte.gnss )
        {
            lte.gnss = {};
        }
        lte.gnss.status = "enable";
      }
      else
      {
        if ( lte.gnss )
        {
            lte.gnss.status = "disable";
        }
      }

      if ( ocompare( lte, ltecopy ) )
      {
          page.alert( { message: $.i18n('Settings unchanged') } );
          return;
      }
      page.confirm( { message: $.i18n('The LTE connecttion will be disconneted because of the change of configuration') } ).then( function(result){
        if ( result )
        {
          he.save( [ obj+"="+JSON.stringify(lte)] ).then( function(){
            page.hint2succeed( $.i18n('Modify successfully') );
            lte_load();
          });
        }
      });
    }



    /* init */
    page.password('password', 'password-icon' );
    $.i18n().load( page.lang('lte') ).then( function () {
      /* init the langauage */
      $.i18n().locale = lang; $('body').i18n();
      /* load the configure */
      status_load();
      lte_load();

      // 设置定时器
      page.timing({
        refresh: function ()
        {
            status_load();
        },
        interval: 3000
      });
      
      /* bind the refresh */
      $('#refresh').on(ace.click_event, function () {
        location.reload();
      });
      /* bind the apply */
      $('#apply').on(ace.click_event, function () {
        lte_save();
      });
    });

  })();
</script>
