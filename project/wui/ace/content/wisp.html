<!-- ajax layout which only needs content area -->
<div class="row" id="page-modes">
  <div class="col-xs-12 form-btn-wrapper">
    <!-- PAGE CONTENT BEGINS -->
    <div class="form-horizontal" role="form">

        <!-- 连接状态 -->
        <table class="table table-bordered table-striped">
        <tbody>
            <tr>
                <th data-i18n="Status"></th>
                <td>
                    <span id="wisp_status"></span>&nbsp; &nbsp;
                    <a class="btn btn-mini btn-warning" id="wisp_btn"><i class="ace-icon fa fa-pause"></i></a>&nbsp;
                </td>
                <th data-i18n="IP Address"></th><td id="wisp_ip"></td>
            </tr>
            <tr>
                <th data-i18n="Peer"></th>
                <td id="wisp_peer"></td> 
                <th data-i18n="Peer MAC"></th>
                <td id="wisp_peermac"></td>
            </tr>
            <tr>
                <th data-i18n="RSSI"></th>
                <td>
                    <span><img src="/assets/css/images/signal_0.png" id="wisp_rssiimg" class="line-signal"></img></span>
                    <span id="wisp_rssi"></span>
                </td>
                <th data-i18n="Channel"></th>
                <td id="wisp_channel"></td>
            </tr>
            <tr>
                <th data-i18n="Live Time"></th>
                <td id="wisp_livetime"></td>
                <th data-i18n="Rate"></th>
                <td id="wisp_rate"></td>
            </tr>
            <tr>
                <th data-i18n="Rx/Tx"></th>
                <td id="wisp_rxtx"></td>
                <th data-i18n="MAC"></th>
                <td id="wisp_mac"></td>
            </tr>
        </tbody>
        </table>            


        <div class="hr hr32 hr-dotted"></div>

        <!-- 扫描 -->
        <div class="form-group">
            <label class="col-sm-3 control-label no-padding-right" data-i18n="Scan"></label>
            <div class="col-sm-9 form-right-text"><button class="btn btn-main btn-mini" id="apscan" data-i18n="Scan"></button></div>
        </div>
        <!-- 对端 -->
        <div class="form-group">
            <label class="col-sm-3 control-label no-padding-right" data-i18n="Peer SSID"></label>
            <div class="col-sm-9"><input type="text" id="peer" class="col-xs-10 col-sm-5" maxlength="128" /></div>
        </div>
        <!-- 对端2 -->
        <div class="form-group">
            <label class="col-sm-3 control-label no-padding-right" data-i18n="Peer SSID2"></label>
            <div class="col-sm-9"><input type="text" id="peer2" class="col-xs-10 col-sm-5" maxlength="128" /></div>
        </div>
        <!-- 对端3 -->
        <div class="form-group">
            <label class="col-sm-3 control-label no-padding-right" data-i18n="Peer SSID3"></label>
            <div class="col-sm-9"><input type="text" id="peer3" class="col-xs-10 col-sm-5" maxlength="128" /></div>
        </div>
        <!-- 锁定信号最强SSID -->
        <div class="form-group">
          <label class="col-sm-3 control-label no-padding-right" data-i18n="Lock Strong Signal"></label>
          <div class="col-sm-9">
            <label>
              <input id="strong" class="ace ace-switch ace-switch-6" type="checkbox" />
              <span class="lbl"></span>
            </label>
          </div>
        </div>

        <!-- 锁定MAC -->
        <div class="form-group">
            <label class="col-sm-3 control-label no-padding-right" data-i18n="Lock BSSID"></label>
            <div class="col-sm-9"><label><input id="lock" class="ace ace-switch ace-switch-6" type="checkbox" /><span class="lbl"></span></label></div>
        </div>
        <div id="lockSets">
            <!-- 对端MAC -->
            <div class="form-group">
                <label class="col-sm-3 control-label no-padding-right" data-i18n="Peer BSSID"></label>
                <div class="col-sm-9"><input type="text" id="peermac" class="col-xs-10 col-sm-5" maxlength="128" /></div>
            </div>
        </div>

        <!-- 安全模式 -->
        <div class="form-group">
            <label class="col-sm-3 control-label no-padding-right" data-i18n="Security Mode"></label>
            <div class="col-sm-9">
                <select class="col-xs-10 col-sm-5" id="secure">
                    <option value="disable" data-i18n="Disable(None)"></option>
                    <option value="wpapsk" data-i18n="WPA(Private)"></option>
                    <option value="wpa2psk" data-i18n="WPA2(Private)"></option>
                    <option value="wpapskwpa2psk" data-i18n="WPA-Mixed(Private)"></option>
                </select>
            </div>
        </div>

        <div id="secureSets">
            <!-- WPA 模式 -->
            <div class="form-group">
            <label class="col-sm-3 control-label no-padding-right" data-i18n="WPA Mode"></label>
                <div class="col-sm-9">
                    <select class="col-xs-10 col-sm-5" id="wpa_encrypt">
                        <option value="tkip" data-i18n="TKIP"></option>
                        <option value="aes" data-i18n="AES"></option>
                        <option value="tkipaes" data-i18n="Auto"></option>
                    </select>
                </div>
            </div>

            <!-- 密码 -->
            <div class="form-group">
                <label class="col-sm-3 control-label no-padding-right" data-i18n="Password"></label>
                <div class="col-sm-9">
                    <span class="input-icon input-icon-right input-icon-form col-xs-10 col-sm-5">
                        <input type="password" id="wpa_key" maxlength="128" autocomplete="new-password" />
                        <i class="ace-icon fa fa-eye-slash" id="wpa_key-icon"></i>
                    </span>
                </div>
            </div>
        </div>

    
        <!-- Hidden SSID -->
        <div class="form-group">
            <label class="col-sm-3 control-label no-padding-right" data-i18n="Hidden SSID"></label>
            <div class="col-sm-9"><label><input id="hidden" class="ace ace-switch ace-switch-6" type="checkbox" /><span class="lbl"></span></label></div>
        </div>

        <div id="hiddenSets">
            <!-- 信道 -->
            <div class="form-group">
            <label class="col-sm-3 control-label no-padding-right" data-i18n="Channel"></label>
                <div class="col-sm-9">
                    <select class="col-xs-10 col-sm-5" id="channel">
                    </select>
                </div>
            </div>
        </div>



        <div class="hr hr32 hr-dotted" id="oneset_line"></div>

        <!-- IPV4拨号模式 -->
        <div class="form-group">
          <label class="col-sm-3 control-label no-padding-right" data-i18n="Dial Mode"></label>
          <div class="col-sm-9">
            <select class="col-xs-10 col-sm-5" id="dialmode">
              <option value="pppoec" data-i18n="PPPOE"></option>
              <option value="dhcpc" data-i18n="DHCP"></option>
              <option value="static" data-i18n="Static IP"></option>
            </select>
          </div>
        </div>


        <!-- Static设置-->
        <div id="staticSets" style="display: none;" >
            <!-- IP地址 -->
            <div class="form-group">
                <label class="col-sm-3 control-label no-padding-right" data-i18n="IP Address"></label>
                <div class="col-sm-9">
                  <div class="clearfix">
                    <input type="text" id="ip" class="col-xs-10 col-sm-5" maxlength="128" />
                  </div>
                </div>
            </div>
            <!-- 掩码 -->
            <div class="form-group">
                <label class="col-sm-3 control-label no-padding-right" data-i18n="Subnet Mask"></label>
                <div class="col-sm-9">
                  <div class="clearfix">
                    <input type="text" id="mask" class="col-xs-10 col-sm-5" maxlength="128" />
                  </div>
                </div>
            </div>
            <!-- 网关 -->
            <div class="form-group">
              <label class="col-sm-3 control-label no-padding-right" data-i18n="Gateway"></label>
              <div class="col-sm-9">
                <div class="clearfix">
                  <input type="text" id="gw" class="col-xs-10 col-sm-5" maxlength="128" />
                </div>
              </div>
            </div>
            <!-- DNS -->
            <div class="form-group">
              <label class="col-sm-3 control-label no-padding-right" data-i18n="DNS"></label>
              <div class="col-sm-9">
                <div class="clearfix">
                  <input type="text" id="dns" class="col-xs-10 col-sm-5" maxlength="128" />
                </div>
              </div>
            </div>
            <!-- DNS2 -->
            <div class="form-group">
              <label class="col-sm-3 control-label no-padding-right" data-i18n="DNS2"></label>
              <div class="col-sm-9">
                <div class="clearfix">
                  <input type="text" id="dns2" class="col-xs-10 col-sm-5" maxlength="128" />
                </div>
              </div>
            </div>
        </div> <!-- staticSets -->
  




        <!-- PPPOE设置-->
        <div id="pppoeSets" style="display: none;" >

            <!-- 拨号用户名 -->
            <div class="form-group">
              <label class="col-sm-3 control-label no-padding-right" data-i18n="Username"></label>
              <div class="col-sm-9">
                <input type="text" id="username" class="col-xs-10 col-sm-5" maxlength="128" />
              </div>
            </div>
            <!-- 拨号密码 -->
            <div class="form-group">
              <label class="col-sm-3 control-label no-padding-right" data-i18n="Password"></label>
              <div class="col-sm-9">
                <span class="input-icon input-icon-right input-icon-form col-xs-10 col-sm-5">
                  <input type="password" id="password" maxlength="128" autocomplete="new-password" />
                  <i class="ace-icon fa fa-eye-slash" id="password-icon"></i>
                </span>
              </div>
            </div>
        
            <!-- mtu -->
            <div class="form-group">
                <label class="col-sm-3 control-label no-padding-right" data-i18n="MTU"></label>
                <div class="col-sm-9">
                  <input type="text" id="mtu" class="col-xs-10 col-sm-5" maxlength="128" />
                </div>
            </div>
            <!-- lcp 间隔 -->
            <div class="form-group">
                <label class="col-sm-3 control-label no-padding-right" data-i18n="LCP Echo Interval"></label>
                <div class="col-sm-9">
                  <input type="text" id="lcp_echo_interval" class="col-xs-10 col-sm-5" maxlength="128" />
                </div>
            </div>
            <!-- lcp 失败次数 -->
            <div class="form-group">
                <label class="col-sm-3 control-label no-padding-right" data-i18n="LCP Echo Times"></label>
                <div class="col-sm-9">
                  <input type="text" id="lcp_echo_failure" class="col-xs-10 col-sm-5" maxlength="128" />
                </div>
            </div>
        </div> <!-- pppoeSets -->





        <!-- 自定义DNS -->
    <div id="custom_dns-select" style="display: none;">
        <div class="form-group">
          <label class="col-sm-3 control-label no-padding-right" data-i18n="Custom DNS"></label>
          <div class="col-sm-9">
            <label>
              <input id="custom_dns" class="ace ace-switch ace-switch-6" type="checkbox" />
              <span class="lbl"></span>
            </label>
          </div>
        </div>
        <div id="custom_dns-sets" style="display: none;">
          <!-- DNS -->
          <div class="form-group">
            <label class="col-sm-3 control-label no-padding-right" data-i18n="DNS"></label>
            <div class="col-sm-9">
              <input type="text" id="cdns" class="col-xs-10 col-sm-5" maxlength="128" />
            </div>
          </div>
          <!-- DNS2 -->
          <div class="form-group">
            <label class="col-sm-3 control-label no-padding-right" data-i18n="DNS2"></label>
            <div class="col-sm-9">
              <input type="text" id="cdns2" class="col-xs-10 col-sm-5" maxlength="128" />
            </div>
          </div>
        </div>
    </div><!-- custom_dns-select -->
    
      <!-- IP伪装 -->
      <div class="form-group">
          <label class="col-sm-3 control-label no-padding-right" data-i18n="IP Masquerade(NAT)"></label>
          <div class="col-sm-9">
              <label>
                  <input id="masq" class="ace ace-switch ace-switch-6" type="checkbox" />
                  <span class="lbl"></span>
              </label>
          </div>
      </div>


<div id="ipv6Sets" style="display: none;" >

    <div class="hr hr32 hr-dotted" id="oneset_line"></div>
    <!-- IPV6拨号模式 -->
    <div class="form-group">
      <label class="col-sm-3 control-label no-padding-right" data-i18n="IPv6 Mode"></label>
      <div class="col-sm-9">
        <select class="col-xs-10 col-sm-5" id="method">
          <option value="disable" data-i18n="Disable"></option>
          <option value="slaac" data-i18n="SLAAC"></option>
          <!-- <option value="automatic" data-i18n="Automatic"></option>
          <option value="manual" data-i18n="Manual"></option> -->
        </select>
      </div>
    </div>

    <!-- Manual设置-->
    <div id="manualSets" style="display: none;" >
        <!-- IPV6地址 -->
        <div class="form-group">
            <label class="col-sm-3 control-label no-padding-right" data-i18n="IPv6 Address"></label>
            <div class="col-sm-9">
              <div class="clearfix">
                <input type="text" id="addr" class="col-xs-10 col-sm-5" maxlength="128" />
              </div>
            </div>
        </div>
  
        <!-- 掩码 -->
        <div class="form-group">
            <label class="col-sm-3 control-label no-padding-right" data-i18n="Subnet Prefix"></label>
            <div class="col-sm-9">
              <div class="clearfix">
                <input type="text" id="prefix" class="col-xs-10 col-sm-5" maxlength="128" />
              </div>
            </div>
        </div>
        <!-- 网关 -->
        <div class="form-group">
          <label class="col-sm-3 control-label no-padding-right" data-i18n="Next Hop"></label>
          <div class="col-sm-9">
            <div class="clearfix">
              <input type="text" id="hop" class="col-xs-10 col-sm-5" maxlength="128" />
            </div>
          </div>
        </div>
  
        <!-- DNS -->
        <div class="form-group">
          <label class="col-sm-3 control-label no-padding-right" data-i18n="DNS"></label>
          <div class="col-sm-9">
            <div class="clearfix">
              <input type="text" id="resolve" class="col-xs-10 col-sm-5" maxlength="128" />
            </div>
          </div>
        </div>
  
        <!-- DNS2 -->
        <div class="form-group">
          <label class="col-sm-3 control-label no-padding-right" data-i18n="DNS2"></label>
          <div class="col-sm-9">
            <div class="clearfix">
              <input type="text" id="resolve2" class="col-xs-10 col-sm-5" maxlength="128" />
            </div>
          </div>
        </div>
    </div> <!-- manualSets -->
</div> <!-- ipv6Sets -->





      <div class="hr hr32 hr-dotted" id="oneset_line"></div>
      <!-- 保活模式 -->
      <div class="form-group">
        <label class="col-sm-3 control-label no-padding-right" data-i18n="Availability Check"></label>
        <div class="col-sm-9">
          <select class="col-xs-10 col-sm-5" id="keeplive">
            <option value="disable" data-i18n="Disalbe"></option>
            <option value="icmp" data-i18n="ICMP"></option>
            <option value="recv" data-i18n="Receive Count"></option>
          </select>
        </div>
      </div>
      <!-- icmp配置 -->
      <div id="icmpSets" style="display: none;">
        <!-- 地址 -->
        <div class="form-group">
          <label class="col-sm-3 control-label no-padding-right" data-i18n="Test Address"></label>
          <div class="col-sm-9">
            <div class="clearfix">
              <input type="text" id="icmp_test" class="col-xs-10 col-sm-5" maxlength="128" />
            </div>
          </div>
        </div>
        <!-- 地址2 -->
        <div class="form-group">
          <label class="col-sm-3 control-label no-padding-right" data-i18n="Test Address 2"></label>
          <div class="col-sm-9">
            <input type="text" id="icmp_test2" class="col-xs-10 col-sm-5" maxlength="128" />
          </div>
        </div>
        <!-- 地址3 -->
        <div class="form-group">
          <label class="col-sm-3 control-label no-padding-right" data-i18n="Test Address 3"></label>
          <div class="col-sm-9">
            <input type="text" id="icmp_test3" class="col-xs-10 col-sm-5" maxlength="128" />
          </div>
        </div>
        <!-- 超时 -->
        <div class="form-group">
          <label class="col-sm-3 control-label no-padding-right" data-i18n="Each Query Timeout(sec)"></label>
          <div class="col-sm-9">
            <input type="text" id="icmp_timeout" class="col-xs-10 col-sm-5" maxlength="128" />
          </div>
        </div>
        <!-- 次数 -->
        <div class="form-group">
          <label class="col-sm-3 control-label no-padding-right" data-i18n="Test Times"></label>
          <div class="col-sm-9">
            <input type="text" id="icmp_failed" class="col-xs-10 col-sm-5" maxlength="128" />
          </div>
        </div>
        <!-- 间隔 -->
        <div class="form-group">
          <label class="col-sm-3 control-label no-padding-right" data-i18n="Test Interval(sec)"></label>
          <div class="col-sm-9">
            <input type="text" id="icmp_interval" class="col-xs-10 col-sm-5" maxlength="128" />
          </div>
        </div>
      </div><!-- icmpSets -->
      <!-- Receive配置 -->
      <div id="recvSets" style="display: none;">
        <!-- 超时 -->
        <div class="form-group">
          <label class="col-sm-3 control-label no-padding-right" data-i18n="Duration(sec)"></label>
          <div class="col-sm-9">
            <input type="text" id="recv_timeout" class="col-xs-10 col-sm-5" maxlength="128" />
          </div>
        </div>
        <!-- 次数 -->
        <div class="form-group">
          <label class="col-sm-3 control-label no-padding-right" data-i18n="Request packets"></label>
          <div class="col-sm-9">
            <input type="text" id="recv_packets" class="col-xs-10 col-sm-5" maxlength="128" />
          </div>
        </div>
      </div><!-- recvSets -->




      

      <div class="clearfix form-actions">
        <div class="col-md-offset-3 col-md-9">
          <button class="btn btn-second" type="button" id="refresh"><span data-i18n="Refresh"></span></button>
          &nbsp; &nbsp; &nbsp;
          <button class="btn btn-main" type="button" id="apply"><span data-i18n="Apply"></span></button>
        </div>
      </div>





      <div id="aplist-modal" class="modal" tabindex="-1">
          <div class="modal-dialog">
              <div class="modal-content">
                <div class="modal-header"><button type="button" class="close" data-dismiss="modal">&times;</button><h4 data-i18n="Choose"></h4></div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-xs-12">
                            <table id="aplist-grid-table"></table>
                            <div id="aplist-grid-pager"></div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-sm btn-main" id="rescan" data-i18n="Rescan"></button>
                    <button class="btn btn-sm btn-second" data-dismiss="modal" data-i18n="Cancel"></button>
                </div>
              </div>
          </div>
      </div>



    </div>
    <!-- PAGE CONTENT ENDS -->
  </div><!-- /.col -->
</div><!-- /.row -->



<!-- page specific plugin scripts -->
<script type="text/javascript">
  (function () {
    /* get the object */
    var wan;
    var wans;
    var chlist;
    var obj = "ifname@wisp";
    var index = location.hash.indexOf("obj=");
    if ( index > 0 )
    {
      obj = location.hash.substring( index+4 );
    }



    /* load the configure on the input */
    function wan_load()
    {
      he.load( [ obj, obj+".chlist" ] ).then( function(v){
        wan = v[0];
        if ( !wan )
        {
            return;
        }
        $('#dialmode').val( wan.mode || 'dhcpc' );
        if ( wan.pppoec )
        {
          $('#username').val(wan.pppoec.username);
          $('#password').val(wan.pppoec.password);
          $('#mtu').val(wan.pppoec.mtu);
          $('#lcp_echo_interval').val(wan.pppoec.lcp_echo_interval);
          $('#lcp_echo_failure').val(wan.pppoec.lcp_echo_failure);
        }
        if ( wan.static )
        {
          if ( wan.static.ipaddr )
          {
            $('#ip').val(wan.static.ipaddr.ip);
            $('#mask').val(wan.static.ipaddr.mask);
          }
          $('#gw').val(wan.static.gw);
          $('#dns').val(wan.static.dns);
          $('#dns2').val(wan.static.dns2);
        }
        $('#masq').prop('checked', able2boole(wan.masq));
        if ( wan.method )
        {
            $('#ipv6Sets').show();
            $('#method').val(wan.method);
            if ( wan.manual )
            {
              if ( wan.manual.addr )
              {
                $('#addr').val(wan.manual.addr);
                $('#prefix').val(wan.manual.prefix);
              }
              $('#hop').val(wan.manual.hop);
              $('#resolve').val(wan.manual.resolve);
              $('#resolve2').val(wan.manual.resolve2);
            }
        }
        $('#keeplive').val( wan.keeplive.type || 'disable');
        if ( wan.keeplive.icmp )
        {
          if (wan.keeplive.icmp.dest)
          {
            $('#icmp_test').val(wan.keeplive.icmp.dest.test)
            $('#icmp_test2').val(wan.keeplive.icmp.dest.test2)
            $('#icmp_test3').val(wan.keeplive.icmp.dest.test3)
          }
          $('#icmp_timeout').val(wan.keeplive.icmp.timeout);
          $('#icmp_failed').val(wan.keeplive.icmp.failed);
          $('#icmp_interval').val(wan.keeplive.icmp.interval);
        }
        if ( wan.keeplive.recv )
        {
          $('#recv_timeout').val(wan.keeplive.recv.timeout);
          $('#recv_packets').val(wan.keeplive.recv.packets);
        }

        $('#custom_dns').unbind('change').change(function () {
          if ($(this).prop('checked'))
          {
            $('#custom_dns-sets').show();
          }
          else
          {
            $('#custom_dns-sets').hide();
          }
        }).trigger('change');
        $('#dialmode').unbind('change').change(function (e) {
          var type = e.target.value;
          switch (type)
          {
            case 'dhcpc':
              $('#staticSets').hide();
              $('#pppoeSets').hide();
              $('#custom_dns-select').show();
              if ( wan.dhcpc )
              {
                $('#custom_dns').prop('checked', able2boole(wan.dhcpc.custom_dns));
                $('#cdns').val( wan.dhcpc.dns );
                $('#cdns2').val( wan.dhcpc.dns2 );
              }
              if ($('#custom_dns').prop('checked'))
              {
                $('#custom_dns-sets').show();
              }
              else
              {
                $('#custom_dns-sets').hide();
              }
              break;
            case 'static':
              $('#staticSets').show();
              $('#pppoeSets').hide();
              $('#custom_dns-select').hide();
              break;
            case 'pppoec':
              $('#staticSets').hide();
              $('#pppoeSets').show();
              $('#custom_dns-select').show();
              if ( wan.pppoec )
              {
                $('#custom_dns').prop('checked', able2boole(wan.pppoec.custom_dns));
                $('#cdns').val( wan.pppoec.dns );
                $('#cdns2').val( wan.pppoec.dns2 );
              }
              if ($('#custom_dns').prop('checked'))
              {
                $('#custom_dns-sets').show();
              }
              else
              {
                $('#custom_dns-sets').hide();
              }
              break;
          }
        }).trigger('change');
        $('#method').unbind('change').change(function (e) {
          var type = e.target.value;
          switch (type)
          {
            case 'disable':
            case 'slaac':
            case 'automatic':
                $('#manualSets').hide();
                break;
            case 'manual':
              $('#manualSets').show();
              break;
          }
        }).trigger('change');
        $('#keeplive').unbind('change').change(function (e) {
          var type = e.target.value;
          switch (type)
          {
              case 'disable':
                $('#icmpSets').hide();
                $('#recvSets').hide();
                break;
              case 'watch':
                $('#icmpSets').hide();
                $('#recvSets').hide();
                break;
              case 'icmp':
                $('#icmpSets').show();
                $('#recvSets').hide();
                break;
              case 'recv':
                $('#icmpSets').hide();
                $('#recvSets').show();
                break;
          }
        }).trigger('change');


        /* here add the sta */
        $('#peer').val( wan.peer || '' );
        $('#peer2').val( wan.peer2 || '' );
        $('#peer3').val( wan.peer3 || '' );
        $('#peermac').val( wan.peermac || '' );
        $('#secure').val( wan.secure || 'disable' );
        $('#wpa_encrypt').val( wan.wpa_encrypt || 'tkipaes' );
        $('#wpa_key').val( wan.wpa_key || '' );
        $('#secure').unbind('change').change(function (e) {
            var secure = e.target.value;
            if ( secure === 'disable' )
            {
                $('#secureSets').hide();
            }
            else
            {
                $('#secureSets').show();
            }
        }).trigger('change');
        $('#strong').prop( 'checked', able2boole(wan.strong) );
        $('#strong').unbind('change').change(function (e) {
            if ($(this).prop('checked'))
            {
                $('#lock').prop( 'checked', false );
                $('#lockSets').hide();
            }
        }).trigger('change');
        $('#lock').prop( 'checked', wan.peermac );
        $('#lock').unbind('change').change(function (e) {
            if ($(this).prop('checked'))
            {
                $('#strong').prop( 'checked', false );
                $('#lockSets').show();
            }
            else
            {
                $('#lockSets').hide();
            }
        }).trigger('change');
        $('#hidden').prop( 'checked', wan.peermode=="hidden" );
        $('#hidden').unbind('change').change(function (e) {
            if ($(this).prop('checked'))
            {
                $('#hiddenSets').show();
            }
            else
            {
                $('#hiddenSets').hide();
            }
        }).trigger('change');
        /* 初始化信道select */
        chlist = v[1];
        var selects = "";
        for ( var ch in chlist )
        {
            selects += ('<option value="' + ch + '">' + $.i18n( ch ) + '</option>');
        }
        $("#channel").html( selects );
        $('#channel').val( wan.channel || '1' );


      })
    }


    /* load the status */
    function status_load()
    {
      he.bkload( [ obj+".status" ] ).then( function(v){
          wans = v[0];
          var info = wans;
          var id = "#wisp";
          /* status end btn */
          if ( info.status )
          {
              $(id).show();
              $(id+"_btn").html( '<i class="ace-icon fa fa-pause"></i>' );
              $(id+"_status").text( $.i18n(info.status) );
              if ( info.status == "up" )
              {
              }
              else if ( info.status == "uping" )
              {
                  if ( info.step )
                  {
                      $(id+"_status").text( $.i18n(info.step) );
                  }
              }
              else if ( info.status == "down" )
              {
                  $(id+"_btn").html( '<i class="ace-icon fa fa-play"></i>' );
              }
              if ( info.error )
              {
                  $(id+"_status").text( $.i18n(info.error) );
              }
          }
          else
          {
              $(id+"_btn").html( '<i class="ace-icon fa fa-play"></i>' );
              $(id+"_status").text( $.i18n("down") );
          }
          /* station */
          if ( info.rate )
          {
              $(id+"_rate").text( info.rate+'Mbps' );
          }
          $(id+"_peer").text( info.peer||' ' );
          $(id+"_peermac").text( info.peermac||' ' );
          $(id+"_channel").text( info.channel||' ' );
          if ( info.sig )
          {
              $(id+"_rssi").text( info.sig+"%" );
          }
          else if ( info.rssi )
          {
              $(id+"_rssi").text( info.rssi+"dBm" );
          }
          if ( info.signal )
          {
              $(id+"_rssiimg").attr( "src", "/assets/css/images/signal_"+info.signal+".png" );            
          }
          $(id+"_mac").text( info.mac||' ' );
          /* network */
          $(id+"_ip").text( info.ip||' ' );
          $(id+"_rxtx").text( byte2readable( (info.rx_bytes||"0") ) + " / " + byte2readable( (info.tx_bytes||"0") ) );
          $(id+"_livetime").text( info.livetime||' ' );
      })
    }

    /* save the configure */
    function wan_save()
    {
      if ( wan == null )
      {
        return;
      }
      var wancopy = JSON.parse(JSON.stringify(wan));;

      wan.mode = $('#dialmode').val();
      if ( wan.mode == "pppoec" )
      {
        if ( !wan.pppoec )
        {
          wan.pppoec = {};
        }
        wan.pppoec.custom_dns = boole2able( $('#custom_dns').prop('checked') );
        if ( wan.pppoec.custom_dns == "enable" )
        {
          wan.pppoec.dns = $('#cdns').val();
          if ( check.ip(wan.pppoec.dns) == false )
          {
              page.alert( { message: $.i18n('DNS')+" "+$.i18n('must be a valid IP address') } );
              return;
          }
          wan.pppoec.dns2 = $('#cdns2').val();
          if ( wan.pppoec.dns2 && check.ip(wan.pppoec.dns2) == false )
          {
              page.alert( { message: $.i18n('DNS2')+" "+$.i18n('must be a valid IP address') } );
              return;
          }
        }
        wan.pppoec.username = $('#username').val();
        wan.pppoec.password = $('#password').val();
        wan.pppoec.mtu = $('#mtu').val();
        if ( wan.pppoec.mtu && check.number(wan.pppoec.mtu) == false )
        {
            page.alert( { message: $.i18n('MTU')+" "+$.i18n('must be a valid number') } );
            return;
        }
        wan.pppoec.lcp_echo_interval = $('#lcp_echo_interval').val();
        if ( wan.pppoec.lcp_echo_interval && check.number(wan.pppoec.lcp_echo_interval) == false )
        {
            page.alert( { message: $.i18n('LCP Echo Interval')+" "+$.i18n('must be a valid number') } );
            return;
        }
        wan.pppoec.lcp_echo_failure = $('#lcp_echo_failure').val();
        if ( wan.pppoec.lcp_echo_failure && check.number(wan.pppoec.lcp_echo_failure) == false )
        {
            page.alert( { message: $.i18n('LCP Echo Times')+" "+$.i18n('must be a valid number') } );
            return;
        }
      }
      else if ( wan.mode == "dhcpc" )
      {
        if ( !wan.dhcpc )
        {
          wan.dhcpc = {};
        }
        wan.dhcpc.custom_dns = boole2able( $('#custom_dns').prop('checked') );
        if ( wan.dhcpc.custom_dns == "enable" )
        {
          wan.dhcpc.dns = $('#cdns').val();
          if ( check.ip(wan.dhcpc.dns) == false )
          {
              page.alert( { message: $.i18n('DNS')+" "+$.i18n('must be a valid IP address') } );
              return;
          }
          wan.dhcpc.dns2 = $('#cdns2').val();
          if ( wan.dhcpc.dns2 && check.ip(wan.dhcpc.dns2) == false )
          {
              page.alert( { message: $.i18n('DNS2')+" "+$.i18n('must be a valid IP address') } );
              return;
          }
        }
      }
      else if ( wan.mode == "static" )
      {
        if ( !wan.static )
        {
            wan.static = {};
        }
        if ( !wan.static.ipaddr )
        {
            wan.static.ipaddr = {};
        }
        wan.static.ipaddr.ip = $('#ip').val();
        if ( check.ip(wan.static.ipaddr.ip) == false )
        {
            page.alert( { message: $.i18n('IP Address')+" "+$.i18n('must be a valid IP address') } );
            return;
        }
        wan.static.ipaddr.mask = $('#mask').val();
        if ( check.ip(wan.static.ipaddr.mask) == false )
        {
            page.alert( { message: $.i18n('Subnet Mask')+" "+$.i18n('must be a valid IP address') } );
            return;
        }
        wan.static.gw = $('#gw').val();
        if ( wan.static.gw && check.ip(wan.static.gw) == false )
        {
            page.alert( { message: $.i18n('Gateway')+" "+$.i18n('must be a valid IP address') } );
            return;
        }
        wan.static.dns = $('#dns').val();
        if ( wan.static.dns && check.ip(wan.static.dns) == false )
        {
            page.alert( { message: $.i18n('DNS')+" "+$.i18n('must be a valid IP address') } );
            return;
        }
        wan.static.dns2 = $('#dns2').val();
        if ( wan.static.dns2 && check.ip(wan.static.dns2) == false )
        {
            page.alert( { message: $.i18n('DNS2')+" "+$.i18n('must be a valid IP address') } );
            return;
        }
      }
      if ( !wan.keeplive )
      {
        wan.keeplive = {};
      }
      wan.masq = boole2able( $('#masq').prop('checked') );
      /* IPV6 */
      if ( wan.method )
      {
          wan.method = $('#method').val();
          if ( wan.method == "manual" )
          {
            if ( !wan.manual )
            {
                wan.manual = {};
            }
            wan.manual.addr = $('#addr').val();
            if ( check.ipv6(wan.manual.addr) == false )
            {
                page.alert( { message: $.i18n('IPv6 Address')+" "+$.i18n('must be a valid IPv6 address') } );
                return;
            }
            wan.manual.prefix = $('#prefix').val();
            if ( wan.manual.prefix && ( wan.manual.prefix < 0 || wan.manual.prefix > 128 ) )
            {
                page.alert( { message: $.i18n('Subnet Prefix')+" "+$.i18n('must be a number(0-128)') } );
                return;
            }
            wan.manual.hop = $('#hop').val();
            if ( wan.manual.hop && check.ipv6(wan.manual.hop) == false )
            {
                page.alert( { message: $.i18n('Next Ho')+" "+$.i18n('must be a valid IPv6 address') } );
                return;
            }
            wan.manual.resolve = $('#resolve').val();
            if ( wan.manual.resolve && check.ipv6(wan.manual.resolve) == false )
            {
                page.alert( { message: $.i18n('DNS')+" "+$.i18n('must be a valid IPv6 address') } );
                return;
            }
            wan.manual.resolve2 = $('#resolve2').val();
            if ( wan.manual.resolve2 && check.ipv6(wan.manual.resolve2) == false )
            {
                page.alert( { message: $.i18n('DNS2')+" "+$.i18n('must be a valid IPv6 address') } );
                return;
            }
          }
      }
      /* Keeplive */
      wan.keeplive.type = $('#keeplive').val();
      if ( wan.keeplive.type == "icmp" )
      {
        if ( !wan.keeplive.icmp )
        {
          wan.keeplive.icmp = {};
        }
        if ( !wan.keeplive.icmp.dest )
        {
          wan.keeplive.icmp.dest = {};
        }
        wan.keeplive.icmp.dest.test = $('#icmp_test').val();
        if ( !wan.keeplive.icmp.dest.test )
        {
            page.alert( { message: $.i18n('Test Address')+" "+$.i18n('can not be empty') } );
            return;
        }
        wan.keeplive.icmp.dest.test2 = $('#icmp_test2').val();
        wan.keeplive.icmp.dest.test3 = $('#icmp_test3').val();
        wan.keeplive.icmp.timeout = $('#icmp_timeout').val();
        if ( check.number(wan.keeplive.icmp.timeout) == false )
        {
            page.alert( { message: $.i18n('Each Query Timeout(sec)')+" "+$.i18n('must be a valid number') } );
            return;
        }
        wan.keeplive.icmp.failed = $('#icmp_failed').val();
        if ( check.number(wan.keeplive.icmp.failed) == false )
        {
            page.alert( { message: $.i18n('Test Times')+" "+$.i18n('must be a valid number') } );
            return;
        }
        wan.keeplive.icmp.interval = $('#icmp_interval').val();
        if ( check.number(wan.keeplive.icmp.interval) == false )
        {
            page.alert( { message: $.i18n('Test Interval(sec)')+" "+$.i18n('must be a valid number') } );
            return;
        }
      }
      else if ( wan.keeplive.type == "recv" )
      {
        if ( !wan.keeplive.recv )
        {
          wan.keeplive.recv = {};
        }
        wan.keeplive.recv.timeout = $('#recv_timeout').val();
        if ( check.number(wan.keeplive.recv.timeout) == false )
        {
            page.alert( { message: $.i18n('Duration(sec)')+" "+$.i18n('must be a valid number') } );
            return;
        }
        wan.keeplive.recv.packets = $('#recv_packets').val();
        if ( check.number(wan.keeplive.recv.packets) == false )
        {
            page.alert( { message: $.i18n('Request packets')+" "+$.i18n('must be a valid number') } );
            return;
        }
      }

      /* here add the sta */
      wan.peer = $('#peer').val();
      wan.peer2 = $('#peer2').val();
      wan.peer3 = $('#peer3').val();
      wan.strong = boole2able( $('#strong').prop('checked') );
      wan.peermac = '';
      if ( $('#lock').prop('checked') )
      {
        wan.peermac = $('#peermac').val();
        if ( check.mac( wan.peermac, true ) == false )
        {
            page.alert( {
                message: $.i18n('Peer BSSID')+" "+$.i18n('must be a valid MAC address'),
                callback: function()
                {
                    $('#peermac').select();
                }
            } );
            return;
        }
      }
      wan.secure = $('#secure').val();
      if ( wan.secure != 'disable' )
      {
          wan.wpa_encrypt = $('#wpa_encrypt').val();
          wan.wpa_key = $('#wpa_key').val();
          if ( !wan.wpa_key )
          {
              page.alert( { message: $.i18n('Password')+" "+$.i18n('can not be empty') } );
              return;
          }
      }
      delete wan.peermode;
      delete wan.channel;
      if ( $('#hidden').prop('checked') )
      {
          wan.peermode = "hidden";
          wan.channel = $('#channel').val();
          if ( !wan.channel )
          {
              page.alert( { message: $.i18n('Channel')+" "+$.i18n('can not be empty') } );
              return;
          }
      }

      if ( ocompare( wan, wancopy ) )
      {
          page.alert( { message: $.i18n('Settings unchanged') } );
          return;
      }
      page.confirm( { message: $.i18n('The WISP connecttion will be disconneted because of the change of configuration') } ).then( function(result){
        if ( result )
        {
          he.save( [ obj+"="+JSON.stringify(wan)] ).then( function(){
            page.hint2succeed( $.i18n('Modify successfully') );
            wan_load();
          });
        }
      });
    }

    //初始化扫描表格
    function init_scan()
    {
    }
    


    /* init */
    page.password('password', 'password-icon' );
    page.password('wpa_key', 'wpa_key-icon' );
    $.i18n().load( page.lang('wan') ).then( function () {
        /* init the langauage */
        $.i18n().locale = lang; $('body').i18n();
        //初始化扫描表格
        jqtable.create( '#aplist-grid-table', '#aplist-grid-pager',
            {
                multiselect: false,
                caption: $.i18n('AP List'),
                colNames: [ $.i18n('Choose'), $.i18n('SSID'), $.i18n('Channel'), $.i18n('Signal'), $.i18n('MAC'), $.i18n('Security Mode'), $.i18n('WPA Mode') ],
                colModel:
                [
                    {
                        name: 'choose', width: 80,
                        fixed: true, sortable: false,
                        formatter: function ( cellvalue, options, rowObject )
                        {
                            return '<button class="btn btn-main btn-xs btn-choose" onclick="ap_select(' + options.rowId + ')" data-id="' + options.rowId + '">' + $.i18n('Choose') + '</button>'
                        }
                    },
                    { name: 'ssid', width: 180 },
                    { name: 'channel', width: 50 },
                    {
                        name: 'signal', width: 50,
                        formatter: function ( cellvalue, options, rowObject )
                        {
                            if ( cellvalue > 0 )
                            {
                                return "<img src='/assets/css/images/signal_"+cellvalue+".png' class='line-signal'></img>";
                            }
                            else
                            {
                                return "<img src='/assets/css/images/signal_0.png' class='line-signal'></img>";
                            }
                        }
                    },
                    { name: 'mac', width: 130 },
                    {
                        name: 'secure', width: 130,
                        formatter: function ( cellvalue )
                        {
                            return '<span data-secure="' + cellvalue + '">' + $.i18n(cellvalue) + '</span>';
                        },
                        unformat: function (cellvalue, options, cell)
                        {
                            return $(cell).children('span').data('secure');
                        }
                    },
                    {
                        name: 'wpa_encrypt', width: 80,
                        formatter: function (cellvalue)
                        {
                            return '<span data-wpa_encrypt="' + cellvalue + '">' + $.i18n(cellvalue) + '</span>';
                        },
                        unformat: function (cellvalue, options, cell)
                        {
                            return $(cell).children('span').data('wpa_encrypt');
                        }
                    }
                ]
            }
        ).jqGrid( 
              'navGrid', '#aplist-grid-pager',
              $.extend(true, {}, jqtable.navOptions, { add: false, edit: false, search: false, refresh: false, del: false, view: false } ),
              {},{},{},{},{},
        );

        /* load the configure */
        status_load();
        wan_load();
        $('#wisp_btn').on(ace.click_event, function () {
            if ( wans.status == "down" )
            {
                he.exec(obj+'.setup').then( function(result){status_load();} );
            }
            else
            {
                he.exec(obj+'.shut').then( function(result){status_load();} );
            }
        });

        // 设置定时器
        page.timing({
          refresh: function ()
          {
              status_load();
          },
          interval: 3000
        });

        // 扫描周围的ap
        $('#apscan').unbind(ace.click_event).on(ace.click_event, function () {
            he.exec( [ obj+'.aplist' ], $.i18n("Scanning") ).then( function(v){
                var list = v[0];
                var rows = json2array( list, {}, "mac" );
                // 给表格赋值
                $('#aplist-grid-table').jqGrid('clearGridData').jqGrid('setGridParam', {
                    data: rows
                }).trigger('reloadGrid');
                $('#aplist-modal').modal('show');
            });
        });
        // 扫描周围的ap
        $('#rescan').unbind(ace.click_event).on(ace.click_event, function () {
            he.exec( [ obj+'.aplist' ], $.i18n("Scanning") ).then( function(v){
                var list = v[0];
                var rows = json2array( list, {}, "mac" );
                // 给表格赋值
                $('#aplist-grid-table').jqGrid('clearGridData').jqGrid('setGridParam', {
                    data: rows
                }).trigger('reloadGrid');
                // 显示对话框
                $('#aplist-modal').modal('show');
            });
        });

        /* bind the refresh */
        $('#refresh').on(ace.click_event, function () {
            location.reload();
        });
        /* bind the apply */
        $('#apply').on(ace.click_event, function () {
            wan_save();
        });

    });


  })();

  /* 必须在全局中才可以被调用到 */
  function ap_select( rowId )
  {
    // 隐藏表格
    $('#aplist-modal').modal('hide');
    // 某个选中行的数据
    var ap = $('#aplist-grid-table').jqGrid( 'getRowData', rowId );
    // 将选中的数据填到对应的输入框中
    $('#peer').val( ap.ssid );
    $('#peermac').val( ap.mac );
    $('#lock').prop( 'checked', false );
    $('#lock').trigger('change');
    $('#secure').val( ap.secure || 'disable');
    // wpa_encrypt 为auto 时设置为tkipaes
    if ( ap.wpa_encrypt === 'auto' )
    {
        $('#wpa_encrypt').val('tkipaes');
    }
    else
    {
        $('#wpa_encrypt').val(ap.wpa_encrypt || 'tkipaes');
    }
    // 手动触发change，以便显示隐藏密码输入框
    $('#secure').trigger('change');
    // $('#wpa_key').val('');
    $('#hidden').prop( 'checked', false );
    $('#hidden').trigger('change');
    $('#radio').val('');
    $('#channel').val('');
  }

  
</script>
