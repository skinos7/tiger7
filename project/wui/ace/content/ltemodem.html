<!-- ajax layout which only needs content area -->
<div class="row" id="page-modes">
  <div class="col-xs-12 form-btn-wrapper">
    <!-- PAGE CONTENT BEGINS -->
    <div class="form-horizontal" role="form">




        <div class="form-group">
          <label class="col-sm-3 control-label no-padding-right" data-i18n="PIN Code"></label>
          <div class="col-sm-9">
            <input type="text" id="lock_pin" class="col-xs-10 col-sm-5" maxlength="128" />
          </div>
        </div>

        <!-- IMEI -->
        <div class="form-group">
            <label class="col-sm-3 control-label no-padding-right" data-i18n="Lock IMEI"></label>
            <div class="col-sm-9">
              <div id="lock_imei" class="col-xs-7 col-sm-3 form-right-text"></div>
              <button class="btn btn-main btn-mini" id="imei_lock" data-i18n="Lock"></button>
            </div>
        </div>
        <!-- IMSI -->
        <div class="form-group">
            <label class="col-sm-3 control-label no-padding-right" data-i18n="Lock IMSI"></label>
            <div class="col-sm-9">
              <div id="lock_imsi" class="col-xs-7 col-sm-3 form-right-text"></div>
              <button class="btn btn-main btn-mini" id="imsi_lock" data-i18n="Lock"></button>
            </div>
        </div>

        <div class="form-group">
          <label class="col-sm-3 control-label no-padding-right" data-i18n="Lock Band"></label>
          <div class="col-sm-9">
            <input type="text" id="lock_band" class="col-xs-10 col-sm-5" maxlength="128" />
          </div>
        </div>
        <div class="form-group">
          <label class="col-sm-3 control-label no-padding-right" data-i18n="Lock Cell"></label>
          <div class="col-sm-9">
            <input type="text" id="lock_cell" class="col-xs-10 col-sm-5" maxlength="128" />
          </div>
        </div>



        <div class="hr hr32 hr-dotted"></div>
        <table id="set-grid-table"></table>
        <div id="set-grid-pager"></div>
        <table id="watch-grid-table"></table>
        <div id="watch-grid-pager"></div>



        <div class="hr hr32 hr-dotted"></div>

        <div class="form-group">
          <label class="col-sm-3 control-label no-padding-right" data-i18n="Need SIM Card"></label>
          <div class="col-sm-9">
            <label>
              <input id="need_simcard" class="ace ace-switch ace-switch-6" type="checkbox" />
              <span class="lbl"></span>
            </label>
          </div>
        </div>

        <div class="form-group">
          <label class="col-sm-3 control-label no-padding-right" data-i18n="Frist number of simcard failures reset modem"></label>
          <div class="col-sm-9">
            <input type="text" id="simcard_failed_threshold" class="col-xs-10 col-sm-5" maxlength="128" />
          </div>
        </div>
        <div class="form-group">
          <label class="col-sm-3 control-label no-padding-right" data-i18n="Second number of simcard failures reset modem"></label>
          <div class="col-sm-9">
            <input type="text" id="simcard_failed_threshold2" class="col-xs-10 col-sm-5" maxlength="128" />
          </div>
        </div>
        <div class="form-group">
          <label class="col-sm-3 control-label no-padding-right" data-i18n="Third number of simcard failures reset modem"></label>
          <div class="col-sm-9">
            <input type="text" id="simcard_failed_threshold3" class="col-xs-10 col-sm-5" maxlength="128" />
          </div>
        </div>
        <div class="form-group">
          <label class="col-sm-3 control-label no-padding-right" data-i18n="Interval number of simcard failures reset modem"></label>
          <div class="col-sm-9">
            <input type="text" id="simcard_failed_everytime" class="col-xs-10 col-sm-5" maxlength="128" />
          </div>
        </div>
        

        <div class="form-group">
          <label class="col-sm-3 control-label no-padding-right" data-i18n="Need PLMN"></label>
          <div class="col-sm-9">
            <label>
              <input id="need_plmn" class="ace ace-switch ace-switch-6" type="checkbox" />
              <span class="lbl"></span>
            </label>
          </div>
        </div>

        <div class="form-group">
          <label class="col-sm-3 control-label no-padding-right" data-i18n="Need Signal"></label>
          <div class="col-sm-9">
            <label>
              <input id="need_signal" class="ace ace-switch ace-switch-6" type="checkbox" />
              <span class="lbl"></span>
            </label>
          </div>
        </div>

        <div class="form-group">
          <label class="col-sm-3 control-label no-padding-right" data-i18n="Frist number of signal failures reset modem"></label>
          <div class="col-sm-9">
            <input type="text" id="signal_failed_threshold" class="col-xs-10 col-sm-5" maxlength="128" />
          </div>
        </div>
        <div class="form-group">
          <label class="col-sm-3 control-label no-padding-right" data-i18n="Second number of signal failures reset modem"></label>
          <div class="col-sm-9">
            <input type="text" id="signal_failed_threshold2" class="col-xs-10 col-sm-5" maxlength="128" />
          </div>
        </div>
        <div class="form-group">
          <label class="col-sm-3 control-label no-padding-right" data-i18n="Third number of signal failures reset modem"></label>
          <div class="col-sm-9">
            <input type="text" id="signal_failed_threshold3" class="col-xs-10 col-sm-5" maxlength="128" />
          </div>
        </div>
        <div class="form-group">
          <label class="col-sm-3 control-label no-padding-right" data-i18n="Interval number of signal failures reset modem"></label>
          <div class="col-sm-9">
            <input type="text" id="signal_failed_everytime" class="col-xs-10 col-sm-5" maxlength="128" />
          </div>
        </div>


        <div class="form-group">
          <label class="col-sm-3 control-label no-padding-right" data-i18n="Watch Interval"></label>
          <div class="col-sm-9">
            <input type="text" id="watch_interval" class="col-xs-10 col-sm-5" maxlength="128" />
          </div>
        </div>




        <div class="hr hr32 hr-dotted"></div>
        <div class="form-group">
          <label class="col-sm-3 control-label no-padding-right" data-i18n="Dial timeout"></label>
          <div class="col-sm-9">
            <input type="text" id="failed_timeout" class="col-xs-10 col-sm-5" maxlength="128" />
          </div>
        </div>
        <div class="form-group">
          <label class="col-sm-3 control-label no-padding-right" data-i18n="Frist number of dial failures reset modem"></label>
          <div class="col-sm-9">
            <input type="text" id="failed_threshold" class="col-xs-10 col-sm-5" maxlength="128" />
          </div>
        </div>
        <div class="form-group">
          <label class="col-sm-3 control-label no-padding-right" data-i18n="Second number of dial failures reset modem"></label>
          <div class="col-sm-9">
            <input type="text" id="failed_threshold2" class="col-xs-10 col-sm-5" maxlength="128" />
          </div>
        </div>
        <div class="form-group">
          <label class="col-sm-3 control-label no-padding-right" data-i18n="Interval number of dial failures reset modem"></label>
          <div class="col-sm-9">
            <input type="text" id="failed_everytime" class="col-xs-10 col-sm-5" maxlength="128" />
          </div>
        </div>



      <div class="clearfix form-actions">
        <div class="col-md-offset-3 col-md-9">
          <button class="btn btn-second" type="button" id="refresh"><span data-i18n="Refresh"></span></button>
          &nbsp; &nbsp; &nbsp;
          <button class="btn btn-main" type="button" id="apply"><span data-i18n="Apply"></span></button>
        </div>
      </div>



    </div>
    <!-- PAGE CONTENT ENDS -->
  </div><!-- /.col -->
</div><!-- /.row -->



<!-- page specific plugin scripts -->
<script type="text/javascript">
  (function () {
    /* get the object */
    var lte;
    var ltes;
    var object = "ifname@lte";
    var index = page.param( 'object', location.hash );
    if ( index )
    {
        object = index;
    }

    /* load the configure on the input */
    function config_load()
    {
      he.load( [ object, object+".custom_set", object+".custom_watch" ] ).then( function(v){
        lte = v[0];
        if ( !lte )
        {
            lte = {};
        }

        if ( lte.lock_imei )
        {
            $('#lock_imei').text( lte.lock_imei );
            $('#imei_lock').hide();
        }
        else
        {
            $('#lock_imei').text( $.i18n("Unlocked" ) );
            $('#imei_lock').show();
        }
        if ( lte.lock_imsi )
        {
            $('#lock_imsi').text( lte.lock_imsi );
            $('#imsi_lock').hide();
        }
        else
        {
            $('#lock_imsi').text( $.i18n("Unlocked" ) );
            $('#imsi_lock').show();
        }

        $('#lock_pin').val( lte.lock_pin||'' );
        $('#lock_band').val( lte.lock_band||'' );
        $('#lock_cell').val( lte.lock_cell||'' );


        if ( lte.custom_set )
        {
            var s = v[1];
            var c = lte.custom_set;
            var rows = [];
            for ( var id in c )
            {
                var at = c[id];
                if ( !at )
                {
                    continue;
                }
                var st = "";
                if ( s )
                {
                    st = s[id];
                }
                var row = { name:id, at:at, result:st };
                rows.push( row );
            }
            var scrollPos = jqtable.getScrollPos();
            $("#set-grid-table").jqGrid('clearGridData').jqGrid('setGridParam', { data: rows }).trigger('reloadGrid');
            jqtable.setScrollPos(scrollPos);
        }
        if ( lte.custom_watch )
        {
            var s = v[2];
            var c = lte.custom_watch;
            var rows = [];
            for ( var id in c )
            {
                var at = c[id];
                if ( !at )
                {
                    continue;
                }
                var st = "";
                if ( s )
                {
                    st = s[id];
                }
                var row = { name:id, at:at, result:st };
                rows.push( row );
            }
            var scrollPos = jqtable.getScrollPos();
            $("#watch-grid-table").jqGrid('clearGridData').jqGrid('setGridParam', { data: rows }).trigger('reloadGrid');
            jqtable.setScrollPos(scrollPos);
        }


        $('#need_simcard').prop('checked', true );
        if ( lte.need_simcard == "disable" )
        {
            $('#need_simcard').prop('checked', false );
        }
        $('#simcard_failed_threshold').val( lte.simcard_failed_threshold||'' );
        $('#simcard_failed_threshold2').val( lte.simcard_failed_threshold2||'' );
        $('#simcard_failed_threshold3').val( lte.simcard_failed_threshold3||'' );
        $('#simcard_failed_everytime').val( lte.simcard_failed_everytime||'' );
        
        $('#need_plmn').prop('checked', true );
        if ( lte.need_plmn == "disable" )
        {
            $('#need_plmn').prop('checked', false );
        }
        $('#need_signal').prop('checked', true );
        if ( lte.need_signal == "disable" )
        {
            $('#need_signal').prop('checked', false );
        }
        $('#signal_failed_threshold').val( lte.signal_failed_threshold||'' );
        $('#signal_failed_threshold2').val( lte.signal_failed_threshold2||'' );
        $('#signal_failed_threshold3').val( lte.signal_failed_threshold3||'' );
        $('#signal_failed_everytime').val( lte.signal_failed_everytime||'' );
        
        $('#watch_interval').val( lte.watch_interval||'' );

        $('#failed_timeout').val( lte.failed_timeout||'' );
        $('#failed_threshold').val( lte.failed_threshold||'' );
        $('#failed_threshold2').val( lte.failed_threshold2||'' );
        $('#failed_everytime').val( lte.failed_everytime||'' );

      })
    }

    /* save the configure */
    function config_save()
    {
      if ( lte == null )
      {
        return;
      }
      var ltecopy = JSON.parse(JSON.stringify(lte));;

      lte.lock_pin = $('#lock_pin').val();
      lte.lock_band = $('#lock_band').val();
      lte.lock_cell = $('#lock_cell').val();

      var data = {};
      var rows = $("#set-grid-table").jqGrid('getDataIDs');
      for ( var i = 0; i < rows.length; i++ )
      {
          var row = $("#set-grid-table").jqGrid('getRowData', rows[i] );
          data[row.name] = row.at;
      }
      if ( rows.length > 0 )
      {
        lte.custom_set = data;
      }
      var data = {};
      var rows = $("#watch-grid-table").jqGrid('getDataIDs');
      for ( var i = 0; i < rows.length; i++ )
      {
          var row = $("#watch-grid-table").jqGrid('getRowData', rows[i] );
          data[row.name] = row.at;
      }
      if ( rows.length > 0 )
      {
        lte.custom_watch = data;
      }

      lte.need_simcard = boole2able( $('#need_simcard').prop('checked') );
      lte.simcard_failed_threshold = $('#simcard_failed_threshold').val();
      lte.simcard_failed_threshold2 = $('#simcard_failed_threshold2').val();
      lte.simcard_failed_threshold3 = $('#simcard_failed_threshold3').val();
      lte.simcard_failed_everytime = $('#simcard_failed_everytime').val();

      lte.need_plmn = boole2able( $('#need_plmn').prop('checked') );
      lte.need_signal = boole2able( $('#need_signal').prop('checked') );
      lte.signal_failed_threshold = $('#signal_failed_threshold').val();
      lte.signal_failed_threshold2 = $('#signal_failed_threshold2').val();
      lte.signal_failed_threshold3 = $('#signal_failed_threshold3').val();
      lte.signal_failed_everytime = $('#signal_failed_everytime').val();

      lte.watch_interval = $('#watch_interval').val();

      lte.failed_timeout = $('#failed_timeout').val();
      lte.failed_threshold = $('#failed_threshold').val();
      lte.failed_threshold2 = $('#failed_threshold2').val();
      lte.failed_everytime = $('#failed_everytime').val();

      if ( ocompare( lte, ltecopy ) )
      {
          page.alert( { message: $.i18n('Settings unchanged') } );
          return;
      }
      page.confirm( { message: $.i18n('The LTE connecttion will be disconneted because of the change of configuration') } ).then( function(result){
        if ( result )
        {
          he.save( [ object+"="+JSON.stringify(lte)] ).then( function(){
            page.hint2succeed( $.i18n('Modify successfully') );
            config_load();
          });
        }
      });
    }



    /* init */
    page.password('passwd', 'password-icon' );
    $.i18n().load( page.lang('lte') ).then( function () {
      /* init the langauage */
      $.i18n().locale = lang; $('body').i18n();

      /* init the table */
      jqtable.create( "#set-grid-table", "set-grid-pager",
        {
            caption: $.i18n("Custom setting AT"),
            colNames: [ $.i18n('Command Name'), $.i18n('AT Command'), $.i18n('Return') ],
            colModel: [
                {
                    name:'name', width:200,
                    editable: true,
                    editrules:{ required: true }
                },
                {
                    name: 'at', width: 300,
                    editable: true,
                    editrules: { required: true }
                },
                {
                    name: 'result', width: 300,
                    editable: false
                }
            ]
        }
      ).jqGrid(
            'navGrid', "#set-grid-pager",
            $.extend(true, {}, jqtable.navOptions, 
                {
                    add: true,addicon : 'ace-icon fa fa-plus-circle purple',
                    del: true,delicon : 'ace-icon fa fa-trash-o red',
                    edit: true,editicon : 'ace-icon fa fa-pencil blue',
                    search: false, refresh: false, view: false
                }
            ),
            jqtable.editOptions,
            jqtable.addOptions,
            jqtable.deleteOptions
      );
      jqtable.create( "#watch-grid-table", "watch-grid-pager",
        {
            caption: $.i18n("Custom watching AT"),
            colNames: [ $.i18n('Command Name'), $.i18n('AT Command'), $.i18n('Return') ],
            colModel: [
                {
                    name:'name', width:200,
                    editable: true,
                    editrules:{ required: true }
                },
                {
                    name: 'at', width: 300,
                    editable: true,
                    editrules: { required: true }
                },
                {
                    name: 'result', width: 300,
                    editable: false
                }
            ]
        }
      ).jqGrid(
            'navGrid', "#watch-grid-pager",
            $.extend(true, {}, jqtable.navOptions, 
                {
                    add: true,addicon : 'ace-icon fa fa-plus-circle purple',
                    del: true,delicon : 'ace-icon fa fa-trash-o red',
                    edit: true,editicon : 'ace-icon fa fa-pencil blue',
                    search: false, refresh: false, view: false
                }
            ),
            jqtable.editOptions,
            jqtable.addOptions,
            jqtable.deleteOptions
      );

      /* load the configure */
      config_load();

      // 锁IMEI
      $('#imei_lock').on(ace.click_event, function () {
          page.confirm( { message: $.i18n('Once locked cannot be undone'), callback:function(result){
              if ( result )
              { 
                  // 执行修改
                  he.exec( [ object+".lock_imei" ] ).then( function(v){
                      var ret = v[0];
                      if ( ret == true )
                      {
                        location.reload();
                      }
                  });
              }
          } } );
      });
      // 锁IMSI
      $('#imsi_lock').on(ace.click_event, function () {
          page.confirm( { message: $.i18n('Once locked cannot be undone'), callback:function(result){
              if ( result )
              { 
                  // 执行修改
                  he.exec( [ object+".lock_imsi" ] ).then( function(v){
                      var ret = v[0];
                      if ( ret == true )
                      {
                        location.reload();
                      }
                  });
              }
          } } );
      });

      /* bind the refresh */
      $('#refresh').on(ace.click_event, function () {
        location.reload();
      });
      /* bind the apply */
      $('#apply').on(ace.click_event, function () {
        config_save();
      });
    });

  })();
</script>
