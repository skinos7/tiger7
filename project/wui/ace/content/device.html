<!-- ajax layout which only needs content area -->
<div class="row">
  <div class="col-xs-12 form-btn-wrapper">
    <!-- PAGE CONTENT BEGINS -->
    <div class="form-horizontal" role="form">




    <!-- 设备名称 -->
    <div class="form-group">
        <label class="col-sm-3 control-label no-padding-right" data-i18n="Device Name"></label>
        <div class="col-sm-9">
          <div id="name_string" class="col-xs-7 col-sm-3 form-right-text"></div>
          <button class="btn btn-main btn-mini" id="name_modify" data-i18n="Modify"></button>
        </div>
    </div>
    <!-- 设备型号 -->
    <div class="form-group" style="display: none;">
        <label class="col-sm-3 control-label no-padding-right" data-i18n="Model"></label>
        <div class="col-sm-9">
          <div id="model_string" class="col-xs-10 col-sm-5 form-right-text"></div>
        </div>
    </div>
    <!-- MAC地址 -->
    <div class="form-group">
        <label class="col-sm-3 control-label no-padding-right" data-i18n="MAC Address"></label>
        <div class="col-sm-9">
          <div id="mac" class="col-xs-10 col-sm-5 form-right-text"></div>
        </div>
    </div>
    <!-- 当前时间 -->
    <div class="form-group">
        <label class="col-sm-3 control-label no-padding-right" data-i18n="Current Time"></label>
        <div class="col-sm-9">
          <div class="col-xs-7 col-sm-3 form-right-text" id="current"></div>
          <button class="btn btn-main btn-mini" id="copy" data-i18n="Copy from computer"></button>
        </div>
    </div>
    <!-- 时间来源 -->
    <div class="form-group">
        <label class="col-sm-3 control-label no-padding-right" data-i18n="Time Source"></label>
        <div class="col-sm-9">
          <div class="col-xs-7 col-sm-3 form-right-text" id="source"></div>
        </div>
    </div>

    <!-- 运行时长 -->
    <div class="form-group">
        <label class="col-sm-3 control-label no-padding-right" data-i18n="Run Time"></label>
        <div class="col-sm-9">
          <div class="col-xs-10 col-sm-5 form-right-text" id="livetime"></div>
        </div>
    </div>

    <div class="form-horizontal" role="form">
      <!-- 系统重启 -->
      <div class="form-group">
        <label class="col-sm-3 control-label no-padding-right"></label>
        <div class="col-sm-9">
          <div class="btn-group">
            <button class="btn btn-warning" data-i18n="System Reboot" id="reboot"></button>
          </div>
        </div>
      </div>
    </div>

    <div class="hr hr32 hr-dotted"></div>

    <!-- 工作模式 -->
    <div class="form-group" id="opmode" style="display: none;">
        <label class="col-sm-3 control-label no-padding-right" data-i18n="Operation Mode"></label>
        <div class="col-sm-9">
          <select class="col-xs-10 col-sm-5" id="mode">
          </select>
        </div>
    </div>


    <div class="hr hr32 hr-dotted"></div>

    <!-- 语言 -->
    <div class="form-group">
        <label class="col-sm-3 control-label no-padding-right" data-i18n="Language Settings"></label>
        <div class="col-sm-9">
          <select class="col-xs-10 col-sm-5" id="language">
            <option value="cn">中文</option>
            <option value="en">English</option>
          </select>
          <span class="form-right-text grey col-xs-12 col-sm-7" data-i18n="Restore to factory will not change its setting"></span>
        </div>
    </div>


    <div class="hr hr32 hr-dotted"></div>


    <!-- 时区 -->
    <div class="form-group">
        <label class="col-sm-3 control-label no-padding-right" data-i18n="Time Zone"></label>
        <div class="col-sm-9">
          <select class="col-xs-10 col-sm-5" id="timezone">
          </select>
        </div>
    </div>

    <!-- NTP客户端状态 -->
    <div class="form-group">
        <label class="col-sm-3 control-label no-padding-right" data-i18n="NTP"></label>
        <div class="col-sm-9">
          <label>
            <input id="ntpclient" class="ace ace-switch ace-switch-6" type="checkbox" />
            <span class="lbl"></span>
          </label>&nbsp; &nbsp; &nbsp;&nbsp; &nbsp; &nbsp;&nbsp; &nbsp; &nbsp;&nbsp; &nbsp; &nbsp;&nbsp; &nbsp; &nbsp;
          <button class="btn btn-main btn-mini" id="sync" data-i18n="Sync"></button>
        </div>
    </div>

    <div id="ntpclientSets">
        <!-- NTP 服务器 -->
        <div class="form-group">
          <label class="col-sm-3 control-label no-padding-right" data-i18n="NTP Server"></label>
          <div class="col-sm-9">
            <input type="text" id="ntpserver" class="col-xs-10 col-sm-5" maxlength="128" />
          </div>
        </div>
        <!-- NTP 服务器2 -->
        <div class="form-group">
          <label class="col-sm-3 control-label no-padding-right" data-i18n="NTP Server2"></label>
          <div class="col-sm-9">
            <input type="text" id="ntpserver2" class="col-xs-10 col-sm-5" maxlength="128" />
          </div>
        </div>
        <!-- NTP 服务器3 -->
        <div class="form-group">
          <label class="col-sm-3 control-label no-padding-right" data-i18n="NTP Server3"></label>
          <div class="col-sm-9">
            <input type="text" id="ntpserver3" class="col-xs-10 col-sm-5" maxlength="128" />
          </div>
        </div>
    </div>

    <!-- NTP服务状态 -->
    <div class="form-group" id="ntpservice_head" style="display: none;">
        <label class="col-sm-3 control-label no-padding-right" data-i18n="NTP Service"></label>
        <div class="col-sm-9">
          <label>
            <input id="ntpservice" class="ace ace-switch ace-switch-6" type="checkbox" />
            <span class="lbl"></span>
          </label>
        </div>
    </div>


      <div class="clearfix form-actions">
        <div class="col-md-offset-3 col-md-9">
          <button class="btn btn-second" type="button" id="refresh"><span data-i18n="Refresh"></span></button>
          &nbsp; &nbsp; &nbsp;
          <button class="btn btn-main" type="button" id="apply"><span data-i18n="Apply"></span></button>
        </div>
      </div>


    </div>
    <!-- PAGE CONTENT ENDS -->
  </div><!-- /.col -->
</div><!-- /.row -->





<!-- page specific plugin scripts -->
<script type="text/javascript">
  (function () {
    var date;
    var dates;
    var ntps;

    /* load the configure on the input */
    function date_load()
    {
        // 所有的时区
        var timezones =  [
            {label: $.i18n('UTC-12(IDL- International Date Line)'),value: '-12'},
            {label: $.i18n('UTC-11(MIT - Midway Island Standard Time)'),value: '-11'},
            {label: $.i18n('UTC-10(HST - Hawaii- Aleutian Standard Time)'),value: '-10'},
            {label: $.i18n('UTC-9:30(MSIT - Marquesas Islands Standard Time)'),value: '-9:30'},
            {label: $.i18n('UTC-9(AKST - Alaska Standard Time)'),value: '-9'},
            {label: $.i18n('UTC-8(PSTA - Pacific Ocean Standard Time A)'),value: '-8'},
            {label: $.i18n('UTC-7(MST - North American mountains Standard Time)'),value: '-7'}, 
            {label: $.i18n('UTC-6(CST - Central North America Standard Time)'),value: '-6'}, 
            {label: $.i18n('UTC-5(EST - Eastern North America Standard Time)'),value: '-5'}, 
            {label: $.i18n('UTC-4(AST - Atlantic Ocean Standard Time)'),value: '-4'}, 
            {label: $.i18n('UTC-3:30(NST -  Newfoundland Standard Time)'),value: '-3:30'}, 
            {label: $.i18n('UTC-3(SAT -  South America Standard Time)'),value: '-3'}, 
            {label: $.i18n('UTC-2(BRT - Brazil Time)'),value: '-2'}, 
            {label: $.i18n('UTC-1(CVT - Cape Verde Standard Time)'),value: '-1'}, 
            {label: $.i18n('UTC(WET - Western European Time Zone, GMT)'),value: '0'}, 
            {label: $.i18n('UTC+1(CET - Mid European Time Zone)'),value: '1'}, 
            {label: $.i18n('UTC+2(EET - Eastern Europe Time Zone)'),value: '2'}, 
            {label: $.i18n('UTC+3(MSK - Moscow Time Zone)'),value: '3'}, 
            {label: $.i18n('UTC+3:30(IRT - Iran Time Zone)'),value: '3:30'}, 
            {label: $.i18n('UTC+4(META - Middle East Time Zone A)'),value: '4'}, 
            {label: $.i18n('UTC+4:30(AFT- Afghanistan Standard Time)'),value: '4:30'}, 
            {label: $.i18n('UTC+5(METB - Middle East Time Zone B)'),value: '5'}, 
            {label: $.i18n('UTC+5:30(IDT - India Standard Time)'),value: '5:30'}, 
            {label: $.i18n('UTC+45(NPT - Nepal Standard Time)'),value: '5:45'}, 
            {label: $.i18n('UTC+6(BHT - Bangladesh Standard Time)'),value: '6'}, 
            {label: $.i18n('UTC+6:30(MRT - Burma Standard Time)'),value: '6:30'}, 
            {label: $.i18n('UTC+7(MST - Thailand Bangkok Standard Time)'),value: '7'}, 
            {label: $.i18n('UTC+8(EAT - China Standard Time(BJT)'),value: '8'}, 
            {label: $.i18n('UTC+8:30(KRT- Korea Republi Standard Time)'),value: '8:30'}, 
            {label: $.i18n('UTC+9(FET- Far East Standard Time)'),value: '9'}, 
            {label: $.i18n('UTC+9:30(ACST - Central Australia Standard Time)'),value: '9:30'}, 
            {label: $.i18n('UTC+10(ACST - Eastern Australia Standard Time)'),value: '10'}, 
            {label: $.i18n('UTC+10:30 (FAST - Far eastern Australia Standard Time)'),value: '10:30'}, 
            {label: $.i18n('UTC+11( VTT - Vanuatu Standard Time)'),value: '11'}, 
            {label: $.i18n('UTC+11:30(NFT - Norfolk Island Standard Time)'),value: '11:30'}, 
            {label: $.i18n('UTC+12(PSTB - Pacific Ocean Standard Time B)'),value: '12'}, 
            {label: $.i18n('UTC+12:45(CIT - Chatham Islands Standard Time)'),value: '12:45'}, 
            {label: $.i18n('UTC+13(PSTC - Pacific Ocean Standard Time C)'),value: '13'}, 
            {label: $.i18n('UTC+14(PSTD - Pacific Ocean Standard Time D)'),value: '14'}
        ];
        // 生成时区select的options
        var options = '';
        for ( var i = 0; i < timezones.length; i++ )
        {
            var timezone = timezones[i];
            options += '<option value="' + timezone.value + '" data-i18n="' + timezone.label + '"></option>';
        }
        // 添加到时区上, 并翻译
        $('#timezone').append(options).i18n();
        he.load( [ 'clock@date', 'clock@date.status', 'clock@ntps' ] ).then( function(v){
            date = v[0];
            dates = v[1];
            ntps = v[2];
            $('#current').text(date2string(dates.current));
            if ( dates.source )
            {
                $('#source').text( $.i18n(dates.source) );
            }
            else
            {
                $('#source').text( $.i18n( "sourcenull" ) );
            }
            $('#livetime').text(time2string(dates.livetime));
            $('#timezone').val(date.timezone || '');
            $('#ntpclient').prop('checked', able2boole(date.ntpclient));
            $('#ntpserver').val(date.ntpserver || '');
            $('#ntpserver2').val(date.ntpserver2 || '');
            $('#ntpserver3').val(date.ntpserver3 || '');
            if ( ntps )
            {
                $('#ntpservice').prop('checked', able2boole(ntps.status));
                $('#ntpservice_head').show();
            }
            else
            {
                $('#ntpservice_head').hide();
            }
            $('#ntpclient').unbind('change').change(function () {
                if ($(this).prop('checked'))
                {
                  $('#ntpclientSets').show();
                  $('#sync').show();
                }
                else
                {
                  $('#ntpclientSets').hide();
                  $('#sync').hide();
                }
            }).trigger('change');
            // 电脑对时
            $('#copy').on(ace.click_event, function () {
                var m;
                var now = new Date();
                // 实际的月份
                m = parseInt(now.getMonth()) + 1;
                // 使用客户端时间
                he.exec( 'clock@date.current['+now.getHours()+':'+now.getMinutes()+':'+now.getSeconds()+':'+m+':'+now.getDate()+':'+now.getFullYear()+']' ).then(function ( result ) {
                    if ( result )
                    {
                        page.hint2succeed($.i18n('Sync successfully'));
                    }
                    else
                    {
                        page.hint2warning($.i18n('Sync Failure'));
                    }
                    date_load();
                });
            });
            // NTP对时
            $('#sync').on(ace.click_event, function () {
                he.exec('clock@date.ntpsync').then(function (result) {
                    if ( result )
                    {
                        page.hint2succeed($.i18n('Sync successfully'));
                    }
                    else
                    {
                        page.hint2warning($.i18n('Sync Failure'));
                    }
                    date_load();
                });
            });
        });
    }
    function date_save()
    {
        var cmd = [];
        var datecopy = null;
        var ntpscopy = null;
        var needsave = false;

        if ( date )
        {
            datecopy = JSON.parse(JSON.stringify(date));
            date.timezone = $('#timezone').val();
            date.ntpclient = boole2able( $('#ntpclient').prop('checked') );
            if ( date.ntpclient == "enable" )
            {
                date.ntpserver = $('#ntpserver').val();
                date.ntpserver2 = $('#ntpserver2').val();
                date.ntpserver3 = $('#ntpserver3').val();
            }
            if ( !ocompare( date, datecopy ) )
            {
                cmd.push( "clock@date="+JSON.stringify(date) );
                needsave = true;
            }
        }
        if ( ntps )
        {
            ntpscopy = JSON.parse(JSON.stringify(ntps));
            if ( boole2able( $('#ntpservice').prop('checked') ) == "enable" )
            {
                ntps.status = "enable";
            }
            else
            {
                ntps.status = "disable";
            }
            if ( !ocompare( ntps, ntpscopy ) )
            {
                cmd.push( "clock@ntps="+JSON.stringify(ntps) );
                needsave = true;
            }
        }

        if ( needsave == false )
        {
          page.alert( { message: $.i18n('Settings unchanged') } );
          return;
        }
        he.save( cmd ).then( function(){
            page.hint2succeed( $.i18n('Modify successfully') );
            date_load();
        });
    }


    /* init */
    $.i18n().load( page.lang('device') ).then( function () {
      /* init the langauage */
      $.i18n().locale = lang; $('body').i18n();
      /* load the info */
      $('#name_string').text(window.machine.name);
      $('#model_string').text(window.machine_status.model);
      if ( !wuimenu || wuimenu.model != "disable" )
      {
          $("#model_string").closest('.form-group').show();
      }
      $('#mac').text(window.machine.mac);
      // 修改设备名
      $('#name_modify').on(ace.click_event, function () {
          page.prompt( { message: $.i18n('Input new device name'), value:window.machine.name, callback:function(result){
              if ( result )
              { 
                  // 执行修改
                  he.exec( [ "land@machine:name="+result ] ).then( function(v){
                      var ret = v[0];
                      if ( ret == true )
                      {
                        location.reload();
                      }
                  });
              }
          } } );
      });
      // 系统重启
      $('#reboot').on(ace.click_event, function () {
          page.confirm( { message: $.i18n('Are you sure you want to restart') } ).then( function(result){
              if ( result )
              { 
                  he.reboot( { title: $.i18n('Restarting...'), hint:$.i18n('Make sure that the device is reconnected') } );
              }
          });
      });
      /* load the mode */
      if ( window.ability && window.ability.mode )
      {
        var m;
        for( m in window.ability.mode )
        {
            if ( window.ability.mode[m] != "null" )
            {
                $("#mode").append("<option value='"+m+"'>" + $.i18n(m) + "</option>");
            }
        }
      }
      else
      {
        $("#mode").append("<option value='misp'>"+$.i18n('misp')+"</option>");
        $("#mode").append("<option value='gateway'>"+$.i18n('gateway')+"</option>");
        $("#mode").append("<option value='wisp'>"+$.i18n('wisp')+"</option>");
      }
      $("#mode").val( window.machine.mode );
      $("#mode").change(function(){
        var nmode = $("#mode").val();
        if ( nmode != window.machine.mode )
        {
            page.confirm( { message: $.i18n('The system will restart because of the change of settings') } ).then( function(result){
                if ( result )
                {
                    he.save( [ "land@machine:mode="+nmode ] ).then( function(){
                        page.confirm( { message: $.i18n('Restart the system to apply') } ).then( function(result){
                            if ( result )
                            {
                                he.reboot( { title: $.i18n('Restarting to apply...'), hint:$.i18n('Make sure that the device is reconnected') } );
                            }
                        });
                    });
                }
                else
                {
                    $("#mode").val( window.machine.mode );
                }
            });
        }
      });
      if ( !wuimenu || wuimenu.opmode != "disable" )
      {
        $("#opmode").show();
      }
      /* load the langauge */
      if ( window.ability && window.ability.language )
      {
        var m;
        $("#language").empty();
        for( m in window.ability.language )
        {
            $("#language").append("<option value='"+m+"'>"+$.i18n(m)+"</option>");
        }
      }
      $("#language").val( window.machine.language );
      $("#language").change(function(){
        var nlang = $("#language").val();
        if ( nlang != window.machine.language )
        {
            page.confirm( { message: $.i18n('Make sure to change the system language') } ).then( function(result){
                if ( result )
                {
                    he.save( [ "arch@data:language="+nlang ] ).then( function(){
                        location.reload(true);
                    });
                }
                else
                {
                    $("#language").val( window.machine.language );
                }
            });
        }
      });      
      date_load();

      /* bind the refresh */
      $('#refresh').on(ace.click_event, function () {
        location.reload();
      });
      /* bind the apply */
      $('#apply').on(ace.click_event, function () {
        date_save();
      });


        
    });
    
  })();
</script>
