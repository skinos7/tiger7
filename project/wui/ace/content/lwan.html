<!-- ajax layout which only needs content area -->
<div class="row" id="page-modes">
  <div class="col-xs-12 form-btn-wrapper">
    <!-- PAGE CONTENT BEGINS -->
    <div class="form-horizontal" role="form">



        <!-- 拨号模式 -->
        <div class="form-group">
          <label class="col-sm-3 control-label no-padding-right" data-i18n="IPv4 Mode"></label>
          <div class="col-sm-9">
            <select class="col-xs-10 col-sm-5" id="mode">
              <option value="dhcpc" data-i18n="DHCP"></option>
              <option value="static" data-i18n="Static IP"></option>
            </select>
          </div>
        </div>

        <!-- dhcpc设置-->
        <div id="dhcpc_cfg" style="display: none;" >
            <!-- 开启备用IP -->
            <div class="form-group">
              <label class="col-sm-3 control-label no-padding-right" data-i18n="Alternate IP Address"></label>
              <div class="col-sm-9">
                <label>
                  <input id="static" class="ace ace-switch ace-switch-6" type="checkbox" />
                  <span class="lbl"></span>
                </label>
              </div>
            </div>
        </div>

        <!-- Static设置-->
        <div id="static_cfg" style="display: none;" >
            <!-- IP地址 -->
            <div class="form-group">
                <label class="col-sm-3 control-label no-padding-right" data-i18n="IPv4 Address"></label>
                <div class="col-sm-9">
                  <div class="clearfix">
                    <input type="text" id="ip" class="col-xs-10 col-sm-5" maxlength="128" />
                  </div>
                </div>
            </div>
            <!-- 掩码 -->
            <div class="form-group">
                <label class="col-sm-3 control-label no-padding-right" data-i18n="Subnet Mask"></label>
                <div class="col-sm-9">
                  <div class="clearfix">
                    <input type="text" id="mask" class="col-xs-10 col-sm-5" maxlength="128" />
                  </div>
                </div>
            </div>

            <div id="gateway_cfg" style="display: none;" >
                <!-- 网关 -->
                <div class="form-group">
                  <label class="col-sm-3 control-label no-padding-right" data-i18n="Gateway"></label>
                  <div class="col-sm-9">
                    <div class="clearfix">
                      <input type="text" id="gw" class="col-xs-10 col-sm-5" maxlength="128" />
                    </div>
                  </div>
                </div>
                <!-- DNS -->
                <div class="form-group">
                  <label class="col-sm-3 control-label no-padding-right" data-i18n="DNS"></label>
                  <div class="col-sm-9">
                    <div class="clearfix">
                      <input type="text" id="dns" class="col-xs-10 col-sm-5" maxlength="128" />
                    </div>
                  </div>
                </div>
                <!-- DNS2 -->
                <div class="form-group">
                  <label class="col-sm-3 control-label no-padding-right" data-i18n="DNS2"></label>
                  <div class="col-sm-9">
                    <div class="clearfix">
                      <input type="text" id="dns2" class="col-xs-10 col-sm-5" maxlength="128" />
                    </div>
                  </div>
                </div>
            </div> <!-- gatewaySets -->

            <div id="dhcps_cfg"  style="display: none;">
                <div class="hr hr32 hr-dotted"></div>
                <!-- DHCP服务器状态 -->
                <div class="form-group">
                  <label class="col-sm-3 control-label no-padding-right" data-i18n="DHCP Server"></label>
                  <div class="col-sm-9">
                    <label>
                      <input id="dhcps" class="ace ace-switch ace-switch-6" type="checkbox" />
                      <span class="lbl"></span>
                    </label>
                  </div>
                </div>
                
                <div id="dhcpsSets" style="display: none;">
                  <!-- 起始IP -->
                  <div class="form-group">
                    <label class="col-sm-3 control-label no-padding-right" data-i18n="Start IP Address"></label>
                    <div class="col-sm-9">
                      <div class="clearfix">
                        <input type="text" id="startip" class="col-xs-10 col-sm-5" maxlength="128" />
                      </div>
                    </div>
                  </div>
                
                  <!-- 结束IP -->
                  <div class="form-group">
                    <label class="col-sm-3 control-label no-padding-right" data-i18n="End IP Address"></label>
                    <div class="col-sm-9">
                      <div class="clearfix">
                        <input type="text" id="endip" class="col-xs-10 col-sm-5" maxlength="128" />
                      </div>
                    </div>
                  </div>
                
                  <!-- 租期 -->
                  <div class="form-group">
                    <label class="col-sm-3 control-label no-padding-right" data-i18n="Lease(Sec)"></label>
                    <div class="col-sm-9">
                      <div class="clearfix">
                        <input type="text" id="lease" class="col-xs-10 col-sm-5" maxlength="128" />
                      </div>
                    </div>
                  </div>
                
                  <!-- 网关 -->
                  <div class="form-group">
                    <label class="col-sm-3 control-label no-padding-right" data-i18n="Assign Gateway"></label>
                    <div class="col-sm-9">
                      <div class="clearfix">
                        <input type="text" id="assign_gw" class="col-xs-10 col-sm-5" maxlength="128" />
                      </div>
                    </div>
                  </div>
                
                  <!-- DNS -->
                  <div class="form-group">
                    <label class="col-sm-3 control-label no-padding-right" data-i18n="Assign DNS"></label>
                    <div class="col-sm-9">
                      <div class="clearfix">
                        <input type="text" id="assign_dns" class="col-xs-10 col-sm-5" maxlength="128" />
                      </div>
                    </div>
                  </div>
                
                  <!-- DNS2 -->
                  <div class="form-group">
                    <label class="col-sm-3 control-label no-padding-right" data-i18n="Assign DNS2"></label>
                    <div class="col-sm-9">
                      <div class="clearfix">
                        <input type="text" id="assign_dns2" class="col-xs-10 col-sm-5" maxlength="128" />
                      </div>
                    </div>
                  </div>
                </div>
                
            </div> <!-- dhcpsSets -->
            
        </div> <!-- staticSets -->
  


    <!-- 自定义DNS -->
    <div id="customdns_cfg" style="display: none;">
        <div class="form-group">
          <label class="col-sm-3 control-label no-padding-right" data-i18n="Custom DNS"></label>
          <div class="col-sm-9">
            <label>
              <input id="custom_dns" class="ace ace-switch ace-switch-6" type="checkbox" />
              <span class="lbl"></span>
            </label>
          </div>
        </div>
        <div id="customdns_config" style="display: none;">
          <!-- DNS -->
          <div class="form-group">
            <label class="col-sm-3 control-label no-padding-right" data-i18n="DNS"></label>
            <div class="col-sm-9">
              <input type="text" id="cdns" class="col-xs-10 col-sm-5" maxlength="128" />
            </div>
          </div>
          <!-- DNS2 -->
          <div class="form-group">
            <label class="col-sm-3 control-label no-padding-right" data-i18n="DNS2"></label>
            <div class="col-sm-9">
              <input type="text" id="cdns2" class="col-xs-10 col-sm-5" maxlength="128" />
            </div>
          </div>
        </div>
    </div><!-- customdns_cfg -->
      

      

      <div class="clearfix form-actions">
        <div class="col-md-offset-3 col-md-9">
          <button class="btn btn-second" type="button" id="refresh"><span data-i18n="Refresh"></span></button>
          &nbsp; &nbsp; &nbsp;
          <button class="btn btn-main" type="button" id="apply"><span data-i18n="Apply"></span></button>
        </div>
      </div>


    </div>
    <!-- PAGE CONTENT ENDS -->
  </div><!-- /.col -->
</div><!-- /.row -->



<!-- page specific plugin scripts -->
<script type="text/javascript">
  (function () {
    /* get the object */
    var wan;
    var object = "ifname@lan";
    var index = page.param( 'object', location.hash );
    if ( index )
    {
        object = index;
    }
    /* load the configure on the input */
    function config_load()
    {
      he.load( [ object ] ).then( function(v){
        wan = v[0];
        /* ipv4 */
        if ( !wan )
        {
            return;
        }
        $('#mode').val( wan.mode || 'dhcpc' );
        if ( wan.static )
        {
          $('#ip').val(wan.static.ip);
          $('#mask').val(wan.static.mask);
          $('#gw').val(wan.static.gw);
          $('#dns').val(wan.static.dns);
          $('#dns2').val(wan.static.dns2);
        }
        if ( wan.dhcpc )
        {
            $('#static').prop('checked', able2boole(wan.dhcpc.static) );
        }
        $('#mode').unbind('change').change(function (e) {
          var type = e.target.value;
          switch (type)
          {
            case 'dhcpc':
              $('#static_cfg').hide();
              $('#dhcpc_cfg').show();
              $('#dhcps_cfg').hide();
              $('#gateway_cfg').hide();
              $('#customdns_cfg').show();
              if ( wan.dhcpc )
              {
                $('#static').prop('checked', able2boole(wan.dhcpc.static) );
                $('#custom_dns').prop('checked', able2boole(wan.dhcpc.custom_dns));
                $('#cdns').val( wan.dhcpc.dns );
                $('#cdns2').val( wan.dhcpc.dns2 );
              }
              if ($('#static').prop('checked'))
              {
                $('#static_cfg').show();
              }
              else
              {
                $('#static_cfg').hide();
              }
              if ($('#custom_dns').prop('checked'))
              {
                $('#customdns_config').show();
              }
              else
              {
                $('#customdns_config').hide();
              }
              break;
            case 'static':
              $('#static_cfg').show();
              $('#dhcpc_cfg').hide();
              $('#dhcps_cfg').show();
              $('#gateway_cfg').show();
              $('#customdns_cfg').hide();
              break;
          }
        }).trigger('change');
        $('#static').unbind('change').change(function () {
          if ($(this).prop('checked'))
          {
            $('#static_cfg').show();
          }
          else
          {
            $('#static_cfg').hide();
          }
        }).trigger('change');
        $('#custom_dns').unbind('change').change(function () {
          if ($(this).prop('checked'))
          {
            $('#customdns_config').show();
          }
          else
          {
            $('#customdns_config').hide();
          }
        }).trigger('change');
        /* dhcps */
        if ( wan.dhcps )
        {
            var dhcps = wan.dhcps;
            $('#dhcps').prop('checked', able2boole(dhcps.status) );
            $('#startip').val(dhcps.startip || '');
            $('#endip').val(dhcps.endip || '');
            $('#lease').val(dhcps.lease || '');
            $('#assign_gw').val(dhcps.gw || '');
            $('#assign_dns').val(dhcps.dns || '');
            $('#assign_dns2').val(dhcps.dns2 || '');
            $('#dhcps').unbind('change').change(function (){
                if ($(this).prop('checked'))
                {
                    $('#dhcps_cfg').show();
                }
                else
                {
                    $('#dhcps_cfg').hide();
                }
            }).trigger('change');
        }

      })
    }

    /* save the configure */
    function config_save()
    {
      if ( wan == null )
      {
        return;
      }
      var wancopy = JSON.parse(JSON.stringify(wan));;

      /* IPV4 addr */
      wan.mode = $('#mode').val();
      if ( wan.mode == "dhcpc" )
      {
        if ( !wan.dhcpc )
        {
          wan.dhcpc = {};
        }
        wan.dhcpc.static = boole2able( $('#static').prop('checked') );
        wan.dhcpc.custom_dns = boole2able( $('#custom_dns').prop('checked') );
        if ( wan.dhcpc.custom_dns == "enable" )
        {
          wan.dhcpc.dns = $('#cdns').val();
          if ( check.ip(wan.dhcpc.dns) == false )
          {
              page.alert( { message: $.i18n('DNS')+" "+$.i18n('must be a valid IP address') } );
              return;
          }
          wan.dhcpc.dns2 = $('#cdns2').val();
          if ( wan.dhcpc.dns2 && check.ip(wan.dhcpc.dns2) == false )
          {
              page.alert( { message: $.i18n('DNS2')+" "+$.i18n('must be a valid IP address') } );
              return;
          }
        }
      }
      if ( wan.mode == "static" || ( wan.mode == "dhcpc" && wan.dhcpc.static == "enable" ) )
      {
        if ( !wan.static )
        {
            wan.static = {};
        }
        wan.static.ip = $('#ip').val();
        if ( check.ip(wan.static.ip) == false )
        {
            page.alert( { message: $.i18n('IPv4 Address')+" "+$.i18n('must be a valid IP address') } );
            return;
        }
        wan.static.mask = $('#mask').val();
        if ( check.ip(wan.static.mask) == false )
        {
            page.alert( { message: $.i18n('Subnet Mask')+" "+$.i18n('must be a valid IP address') } );
            return;
        }
        wan.static.gw = $('#gw').val();
        if ( wan.static.gw && check.ip(wan.static.gw) == false )
        {
            page.alert( { message: $.i18n('Gateway')+" "+$.i18n('must be a valid IP address') } );
            return;
        }
        wan.static.dns = $('#dns').val();
        if ( wan.static.dns && check.ip(wan.static.dns) == false )
        {
            page.alert( { message: $.i18n('DNS')+" "+$.i18n('must be a valid IP address') } );
            return;
        }
        wan.static.dns2 = $('#dns2').val();
        if ( wan.static.dns2 && check.ip(wan.static.dns2) == false )
        {
            page.alert( { message: $.i18n('DNS2')+" "+$.i18n('must be a valid IP address') } );
            return;
        }
        /* DHCPS */
        if ( !wan.dhcps )
        {
            wan.dhcps = {};
        }
        if ( wan.mode == "dhcpc" )
        {
            wan.dhcps.status = "disable";
        }
        else
        {
            var dhcps = wan.dhcps;
            dhcps.status = boole2able( $('#dhcps').prop('checked') );
            if ( dhcps.status == "enable" )
            {
                dhcps.startip = $('#startip').val();
                if ( check.ip(dhcps.startip) == false )
                {
                    page.alert( { message: $.i18n('Start IP Address')+" "+$.i18n('must be a valid IP address') } );
                    return;
                }
                dhcps.endip = $('#endip').val();
                if ( check.ip(dhcps.endip) == false )
                {
                    page.alert( { message: $.i18n('End IP Address')+" "+$.i18n('must be a valid IP address') } );
                    return;
                }
                dhcps.mask = $('#mask').val();
                dhcps.lease = $('#lease').val();
                if ( dhcps.lease && check.number(dhcps.lease) == false )
                {
                    page.alert( { message: $.i18n('Lease(Sec)')+" "+$.i18n('must be a valid number') } );
                    return;
                }
                dhcps.gw = $('#gw').val();
                if ( dhcps.gw && check.ip(dhcps.gw) == false )
                {
                    page.alert( { message: $.i18n('Assign Gateway')+" "+$.i18n('must be a valid IP address') } );
                    return;
                }
                dhcps.dns = $('#dns').val();
                if ( dhcps.dns && check.ip(dhcps.dns) == false )
                {
                    page.alert( { message: $.i18n('Assign DNS')+" "+$.i18n('must be a valid IP address') } );
                    return;
                }
                dhcps.dns2 = $('#dns2').val();
                if ( dhcps.dns2 && check.ip(dhcps.dns2) == false )
                {
                    page.alert( { message: $.i18n('Assign DNS2')+" "+$.i18n('must be a valid IP address') } );
                    return;
                }
            }
        }
      }

      // 校正DHCP池地址
      if ( wan.static.ip != wancopy.static.ip 
          && wan.dhcps.startip == wancopy.dhcps.startip
          && wan.dhcps.endip == wancopy.dhcps.endip )
      {
          var arr = ipadd2array( wan.static.ip, wan.static.mask );
          // 起始IP
          arr[3] = 2;
          wan.dhcps.startip = arr.join('.');
          // 结束IP
          arr[3] = 250;
          wan.dhcps.endip = arr.join('.');
      }
      
      page.confirm( { message: $.i18n('The system will restart because of the change of configuration') } ).then( function(result){
          if ( result )
          {
              he.save( [ object+"="+JSON.stringify(wan)] ).then( function(){
                  page.confirm( { message: $.i18n('Need to restart the system') } ).then( function(result){
                      if ( result )
                      {
                          he.reboot( { title: $.i18n('Restarting to apply...'), hint:$.i18n('Make sure that the device is reconnected') } );
                      }
                      else
                      {
                          lan_load();
                      }
                  });
              });
          }
      });
      
    }



    /* init */
    $.i18n().load( page.lang('lan') ).then( function () {
        /* init the langauage */
        $.i18n().locale = lang; $('body').i18n();

        /* load the configure */
        config_load();

        /* bind the refresh */
        $('#refresh').on(ace.click_event, function () {
            location.reload();
        });
        /* bind the apply */
        $('#apply').on(ace.click_event, function () {
            config_save();
        });
    });

  })();
</script>
