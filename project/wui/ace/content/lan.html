<!-- ajax layout which only needs content area -->
<div class="row" id="page-modes">
  <div class="col-xs-12 form-btn-wrapper">
    <!-- PAGE CONTENT BEGINS -->
    <div class="form-horizontal" role="form">


        <!-- IP地址 -->
        <div class="form-group">
            <label class="col-sm-3 control-label no-padding-right" data-i18n="IPv4 Address"></label>
            <div class="col-sm-9">
              <div class="clearfix">
                <input type="text" id="ip" class="col-xs-10 col-sm-5" maxlength="128" />
              </div>
            </div>
        </div>
  
        <!-- 掩码 -->
        <div class="form-group">
            <label class="col-sm-3 control-label no-padding-right" data-i18n="Subnet Mask"></label>
            <div class="col-sm-9">
              <div class="clearfix">
                <input type="text" id="mask" class="col-xs-10 col-sm-5" maxlength="128" />
              </div>
            </div>
        </div>


      <div class="hr hr32 hr-dotted"></div>
      <!-- DHCP服务器状态 -->
      <div class="form-group">
        <label class="col-sm-3 control-label no-padding-right" data-i18n="DHCP Server"></label>
        <div class="col-sm-9">
          <label>
            <input id="dhcps" class="ace ace-switch ace-switch-6" type="checkbox" />
            <span class="lbl"></span>
          </label>
        </div>
      </div>
      
      <div id="pool_cfg" style="display: none;">

        <!-- 起始IP -->
        <div class="form-group">
          <label class="col-sm-3 control-label no-padding-right" data-i18n="Start IP Address"></label>
          <div class="col-sm-9">
            <div class="clearfix">
              <input type="text" id="startip" class="col-xs-10 col-sm-5" maxlength="128" />
            </div>
          </div>
        </div>

        <!-- 结束IP -->
        <div class="form-group">
          <label class="col-sm-3 control-label no-padding-right" data-i18n="End IP Address"></label>
          <div class="col-sm-9">
            <div class="clearfix">
              <input type="text" id="endip" class="col-xs-10 col-sm-5" maxlength="128" />
            </div>
          </div>
        </div>
  
        <!-- 租期 -->
        <div class="form-group">
          <label class="col-sm-3 control-label no-padding-right" data-i18n="Lease(Sec)"></label>
          <div class="col-sm-9">
            <div class="clearfix">
              <input type="text" id="lease" class="col-xs-10 col-sm-5" maxlength="128" />
            </div>
          </div>
        </div>
  
        <!-- 网关 -->
        <div class="form-group">
          <label class="col-sm-3 control-label no-padding-right" data-i18n="Assign Gateway"></label>
          <div class="col-sm-9">
            <div class="clearfix">
              <input type="text" id="gw" class="col-xs-10 col-sm-5" maxlength="128" />
            </div>
          </div>
        </div>
  
        <!-- DNS -->
        <div class="form-group">
          <label class="col-sm-3 control-label no-padding-right" data-i18n="Assign DNS"></label>
          <div class="col-sm-9">
            <div class="clearfix">
              <input type="text" id="dns" class="col-xs-10 col-sm-5" maxlength="128" />
            </div>
          </div>
        </div>
  
        <!-- DNS2 -->
        <div class="form-group">
          <label class="col-sm-3 control-label no-padding-right" data-i18n="Assign DNS2"></label>
          <div class="col-sm-9">
            <div class="clearfix">
              <input type="text" id="dns2" class="col-xs-10 col-sm-5" maxlength="128" />
            </div>
          </div>
        </div>
      </div><!-- dhcpsSets -->







        <div id="ipv6_cfg" style="display: none;" >

            <div class="hr hr32 hr-dotted"></div>
            <!-- IPV6地址 -->
            <div class="form-group">
                <label class="col-sm-3 control-label no-padding-right" data-i18n="IPv6 Mode"></label>
                <div class="col-sm-9">
                    <select class="col-xs-10 col-sm-5" id="method">
                      <option value="disable" data-i18n="Disable"></option>
                      <option value="relay" data-i18n="Relay"></option>
                      <!-- <option value="manual" data-i18n="Manual"></option> -->
                    </select>
                </div>
            </div>
            <div id="manual_cfg" style="display: none;" >
                <!-- IPV6地址 -->
                <div class="form-group">
                    <label class="col-sm-3 control-label no-padding-right" data-i18n="IPv6 Address"></label>
                    <div class="col-sm-9">
                      <div class="clearfix">
                        <input type="text" id="addr" class="col-xs-10 col-sm-5" maxlength="128" />
                      </div>
                    </div>
                </div>
                <!-- IPV6掩码 -->
                <div class="form-group">
                    <label class="col-sm-3 control-label no-padding-right" data-i18n="Subnet Prefix"></label>
                    <div class="col-sm-9">
                      <div class="clearfix">
                        <input type="text" id="prefix" class="col-xs-10 col-sm-5" maxlength="128" />
                      </div>
                    </div>
                </div>
                <!-- DHCP服务器状态 -->
                <div class="hr hr32 hr-dotted" id="oneset_line"></div>
                <div class="form-group">
                  <label class="col-sm-3 control-label no-padding-right" data-i18n="DHCPV6 Server"></label>
                  <div class="col-sm-9">
                    <label>
                      <input id="dhcpsv6" class="ace ace-switch ace-switch-6" type="checkbox" />
                      <span class="lbl"></span>
                    </label>
                  </div>
                </div>
            </div> <!-- ipv6Manual -->
        </div> <!-- ipv6Sets -->



        <div id="dhcpsv6_cfg" style="display: none;" >
            <!-- 起始IPV6 -->
            <div class="form-group">
              <label class="col-sm-3 control-label no-padding-right" data-i18n="Start IPv6 Address"></label>
              <div class="col-sm-9">
                <div class="clearfix">
                  <input type="text" id="startaddr" class="col-xs-10 col-sm-5" maxlength="128" />
                </div>
              </div>
            </div>
            
            <!-- 结束IPV6 -->
            <div class="form-group">
              <label class="col-sm-3 control-label no-padding-right" data-i18n="End IPv6 Address"></label>
              <div class="col-sm-9">
                <div class="clearfix">
                  <input type="text" id="endaddr" class="col-xs-10 col-sm-5" maxlength="128" />
                </div>
              </div>
            </div>
            
            <!-- 租期 -->
            <div class="form-group">
              <label class="col-sm-3 control-label no-padding-right" data-i18n="IPv6 Lease(Sec)"></label>
              <div class="col-sm-9">
                <div class="clearfix">
                  <input type="text" id="leasetime" class="col-xs-10 col-sm-5" maxlength="128" />
                </div>
              </div>
            </div>
            <!-- 网关 -->
            <div class="form-group">
              <label class="col-sm-3 control-label no-padding-right" data-i18n="IPv6 Next Hop"></label>
              <div class="col-sm-9">
                <div class="clearfix">
                  <input type="text" id="hop" class="col-xs-10 col-sm-5" maxlength="128" />
                </div>
              </div>
            </div>
            <!-- DNS -->
            <div class="form-group">
              <label class="col-sm-3 control-label no-padding-right" data-i18n="IPv6 DNS"></label>
              <div class="col-sm-9">
                <div class="clearfix">
                  <input type="text" id="resolve" class="col-xs-10 col-sm-5" maxlength="128" />
                </div>
              </div>
            </div>
            <!-- DNS2 -->
            <div class="form-group">
              <label class="col-sm-3 control-label no-padding-right" data-i18n="IPv6 DNS2"></label>
              <div class="col-sm-9">
                <div class="clearfix">
                  <input type="text" id="resolve2" class="col-xs-10 col-sm-5" maxlength="128" />
                </div>
              </div>
            </div>
        </div> <!-- dhcpsv6Sets -->
        





      <div class="clearfix form-actions">
        <div class="col-md-offset-3 col-md-9">
          <button class="btn btn-second" type="button" id="refresh"><span data-i18n="Refresh"></span></button>
          &nbsp; &nbsp; &nbsp;
          <button class="btn btn-main" type="button" id="apply"><span data-i18n="Apply"></span></button>
        </div>
      </div>


    </div>
    <!-- PAGE CONTENT ENDS -->
  </div><!-- /.col -->
</div><!-- /.row -->



<!-- page specific plugin scripts -->
<script type="text/javascript">
  (function () {
    /* get the object */
    var lan;
    object = "ifname@lan";
    var index = page.param( 'object', location.hash );
    if ( index )
    {
        object = index;
    }
    /* load the configure on the input */
    function config_load()
    {
      he.load( [ object ] ).then( function(v){
        lan = v[0];
        if ( !lan )
        {
            return;
        }
        /* ipv4 */
        if ( lan.static )
        {
            $('#ip').val(lan.static.ip || '');
            $('#mask').val(lan.static.mask || '');
        }
        /* dhcpsv4 */
        if ( lan.dhcps )
        {
            var dhcps = lan.dhcps;
            $('#dhcps').prop('checked', able2boole(dhcps.status) );
            $('#startip').val(dhcps.startip || '');
            $('#endip').val(dhcps.endip || '');
            $('#lease').val(dhcps.lease || '');
            $('#gw').val(dhcps.gw || '');
            $('#dns').val(dhcps.dns || '');
            $('#dns2').val(dhcps.dns2 || '');
            $('#dhcps').unbind('change').change(function (){
                if ($(this).prop('checked'))
                {
                    $('#pool_cfg').show();
                }
                else
                {
                    $('#pool_cfg').hide();
                }
            }).trigger('change');
        }
        /* ipv6 */
        if ( lan.manual && lan.manual.addr )
        {
            $('#addr').val(lan.manual.addr || '');
            $('#prefix').val(lan.manual.prefix || '');
        }
        if ( lan.method )
        {
            $('#ipv6_cfg').show();
            $('#method').val( lan.method||"disable" );
            $('#method').unbind('change').change(function (e) {
              var type = e.target.value;
              switch (type)
              {
                case 'disable':
                  $('#manual_cfg').hide();
                  break;
                case 'relay':
                  $('#manual_cfg').hide();
                  break;
                case 'manual':
                  $('#manual_cfg').show();
                  break;
              }
            }).trigger('change');
              /* dhcpsv6 */
            if ( lan.dhcpsv6 )
            {
                var dhcps = lan.dhcpsv6;
                $('#dhcpsv6').prop('checked', able2boole(dhcps.status) );
                $('#startaddr').val(dhcps.startaddr || '');
                $('#endaddr').val(dhcps.endaddr || '');
                $('#leasetime').val(dhcps.leasetime || '');
                $('#hop').val(dhcps.hop || '');
                $('#resolve').val(dhcps.resolve || '');
                $('#resolve2').val(dhcps.resolve2 || '');
            }
            $('#dhcpsv6').unbind('change').change(function (){
                if ($(this).prop('checked'))
                {
                    $('#dhcpsv6_cfg').show();
                }
                else
                {
                    $('#dhcpsv6_cfg').hide();
                }
            }).trigger('change');
        }
      });
    }

    /* save the configure */
    function config_save()
    {
        if ( lan == null )
        {
            return;
        }
        var lancopy = JSON.parse(JSON.stringify(lan));

        /* IPV4 addr */
        if ( !lan.static )
        {
            lan.static = {};
        }
        lan.mode = "static";
        lan.static.ip = $('#ip').val();
        if ( check.ip(lan.static.ip) == false )
        {
            page.alert( { message: $.i18n('IPv4 Address')+" "+$.i18n('must be a valid IP address') } );
            return;
        }
        lan.static.mask = $('#mask').val();
        if ( check.ip(lan.static.mask) == false )
        {
            page.alert( { message: $.i18n('Subnet Mask')+" "+$.i18n('must be a valid IP address') } );
            return;
        }
        /* IPV4 dhcps */
        if ( !lan.dhcps )
        {
            lan.dhcps = {};
        }
        var dhcps = lan.dhcps;
        dhcps.status = boole2able( $('#dhcps').prop('checked') );
        if ( dhcps.status == "enable" )
        {
            dhcps.startip = $('#startip').val();
            if ( check.ip(dhcps.startip) == false )
            {
                page.alert( { message: $.i18n('Start IP Address')+" "+$.i18n('must be a valid IP address') } );
                return;
            }
            dhcps.endip = $('#endip').val();
            if ( check.ip(dhcps.endip) == false )
            {
                page.alert( { message: $.i18n('End IP Address')+" "+$.i18n('must be a valid IP address') } );
                return;
            }
            dhcps.mask = $('#mask').val();
            dhcps.lease = $('#lease').val();
            if ( dhcps.lease && check.number(dhcps.lease) == false )
            {
                page.alert( { message: $.i18n('Lease(Sec)')+" "+$.i18n('must be a valid number') } );
                return;
            }
            dhcps.gw = $('#gw').val();
            if ( dhcps.gw && check.ip(dhcps.gw) == false )
            {
                page.alert( { message: $.i18n('Assign Gateway')+" "+$.i18n('must be a valid IP address') } );
                return;
            }
            dhcps.dns = $('#dns').val();
            if ( dhcps.dns && check.ip(dhcps.dns) == false )
            {
                page.alert( { message: $.i18n('Assign DNS')+" "+$.i18n('must be a valid IP address') } );
                return;
            }
            dhcps.dns2 = $('#dns2').val();
            if ( dhcps.dns2 && check.ip(dhcps.dns2) == false )
            {
                page.alert( { message: $.i18n('Assign DNS2')+" "+$.i18n('must be a valid IP address') } );
                return;
            }
        }
        /* IPV6 addr */
        if ( lan.method )
        {
            lan.method = $('#method').val();
            if ( lan.method == "manual" )
            {
                if ( !lan.manual )
                {
                    lan.manual = {};
                }
                lan.manual.addr = $('#addr').val();
                if ( check.ipv6(lan.manual.addr) == false )
                {
                    page.alert( { message: $.i18n('IPv6 Address')+" "+$.i18n('must be a valid IPv6 address') } );
                    return;
                }
                lan.manual.prefix = $('#prefix').val();
                if ( lan.manual.prefix && ( lan.manual.prefix < 0 || lan.manual.prefix > 128 ) )
                {
                    page.alert( { message: $.i18n('Subnet Prefix')+" "+$.i18n('must be a number(0-128)') } );
                    return;
                }
                /* IPV6 dhcps */
                if ( !lan.dhcpsv6 )
                {
                    lan.dhcpsv6 = {};
                }
                var dhcps = lan.dhcpsv6;
                dhcps.status = boole2able( $('#dhcpsv6').prop('checked') );
                if ( dhcps.status == "enable" )
                {
                    dhcps.startaddr = $('#startaddr').val();
                    if ( check.ipv6(dhcps.startaddr) == false )
                    {
                        page.alert( { message: $.i18n('Start IPv6 Address')+" "+$.i18n('must be a valid IPv6 address') } );
                        return;
                    }
                    dhcps.endaddr = $('#endaddr').val();
                    if ( check.ipv6(dhcps.endaddr) == false )
                    {
                        page.alert( { message: $.i18n('End IPv6 Address')+" "+$.i18n('must be a valid IPv6 address') } );
                        return;
                    }
                    dhcps.prefix = $('#prefix').val();
                    dhcps.leasetime = $('#leasetime').val();
                    if ( dhcps.leasetime && check.number(dhcps.leasetime) == false )
                    {
                        page.alert( { message: $.i18n('IPv6 Lease(Sec)')+" "+$.i18n('must be a valid number') } );
                        return;
                    }
                    dhcps.hop = $('#hop').val();
                    if ( dhcps.hop && check.ipv6(dhcps.hop) == false )
                    {
                        page.alert( { message: $.i18n('IPv6 Next Hop')+" "+$.i18n('must be a valid IPv6 address') } );
                        return;
                    }
                    dhcps.resolve = $('#resolve').val();
                    if ( dhcps.resolve && check.ipv6(dhcps.resolve) == false )
                    {
                        page.alert( { message: $.i18n('IPv6 DNS')+" "+$.i18n('must be a valid IPv6 address') } );
                        return;
                    }
                    dhcps.resolve2 = $('#resolve2').val();
                    if ( dhcps.resolve2 && check.ipv6(dhcps.resolve2) == false )
                    {
                        page.alert( { message: $.i18n('IPv6 DNS2')+" "+$.i18n('must be a valid IPv6 address') } );
                        return;
                    }
                }
            }
        }
        
        
        if ( ocompare( lan, lancopy ) )
        {
            page.alert( { message: $.i18n('Settings unchanged') } );
            return;
        }

        // 校正DHCP池地址
        if ( lan.static.ip != lancopy.static.ip 
            && lan.dhcps.startip == lancopy.dhcps.startip
            && lan.dhcps.endip == lancopy.dhcps.endip )
        {
            var arr = ipadd2array( lan.static.ip, lan.static.mask );
            // 起始IP
            arr[3] = 2;
            lan.dhcps.startip = arr.join('.');
            // 结束IP
            arr[3] = 250;
            lan.dhcps.endip = arr.join('.');
        }
        
        page.confirm( { message: $.i18n('The system will restart because of the change of configuration') } ).then( function(result){
            if ( result )
            {
                he.save( [ object+"="+JSON.stringify(lan)] ).then( function(){
                    page.confirm( { message: $.i18n('Need to restart the system') } ).then( function(result){
                        if ( result )
                        {
                            he.reboot( { title: $.i18n('Restarting to apply...'), hint:$.i18n('Make sure that the device is reconnected') } );
                        }
                        else
                        {
                            config_load();
                        }
                    });
                });
            }
        });
    }



    /* init */
    $.i18n().load( page.lang('lan') ).then( function () {
      /* init the langauage */
      $.i18n().locale = lang; $('body').i18n();

      /* load the configure */
      config_load();

      /* bind the refresh */
      $('#refresh').on(ace.click_event, function () {
        location.reload();
      });
      /* bind the apply */
      $('#apply').on(ace.click_event, function () {
        config_save();
      });
    });

  })();
</script>
